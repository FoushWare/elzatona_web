---
description: Automatic test updates when working on features or bugs - MANDATORY CHECKLIST INCLUDED
globs: **/*.test.{ts,tsx,js,jsx}, **/*.spec.{ts,tsx,js,jsx}, **/*.integration.test.{ts,tsx,js,jsx}, **/__snapshots__/**/*.snap, Rest/markdown/docs/testing/**/*.md
alwaysApply: true
---

# Testing Rules for Automatic Updates

## ‚ö†Ô∏è MANDATORY CHECKLIST - READ THIS FIRST

**EVERY time you work on ANY code change (feature, bug fix, refactor, etc.), you MUST complete this checklist:**

### ‚úÖ **MANDATORY TEST UPDATE CHECKLIST**

- [ ] **1. Identify affected test files**
  - [ ] Find unit test files (`*.test.tsx`, `*.test.ts`)
  - [ ] Find integration test files (`*.integration.test.tsx`)
  - [ ] Find E2E test files (`*.spec.ts`, `*.spec.tsx`)
  - [ ] Find snapshot test files (`__snapshots__/*.snap`)

- [ ] **2. Update Unit Tests**
  - [ ] Update existing unit tests if component/function changed
  - [ ] Add new unit tests for new functionality
  - [ ] Remove/update obsolete tests
  - [ ] Verify all unit tests pass: `npm run test:unit`

- [ ] **3. Update Integration Tests**
  - [ ] Update integration tests if API/flow changed
  - [ ] Add new integration tests for new flows
  - [ ] Test API interactions and data flow
  - [ ] Verify all integration tests pass: `npm run test:integration`

- [ ] **4. Update E2E Tests**
  - [ ] Update E2E tests if user flow changed
  - [ ] Add new E2E tests for new user flows
  - [ ] Test complete user journeys
  - [ ] Verify all E2E tests pass: `npm run test:e2e`

- [ ] **5. Update Snapshot Tests** ‚ö†Ô∏è **REQUIRED**
  - [ ] Update snapshots if UI/structure changed: `npm run test:unit -- --updateSnapshot`
  - [ ] Review snapshot changes carefully (don't blindly accept)
  - [ ] Add new snapshot tests for new components/pages
  - [ ] Test different states (loading, error, empty, populated)
  - [ ] Verify snapshots match expected UI: `npm run test:unit`

- [ ] **6. Update Test Documentation**
  - [ ] Update test task file in `Rest/markdown/docs/testing/tasks/`
  - [ ] Update `TASK_INDEX.md` if test status changed
  - [ ] Document any new test cases or edge cases discovered
  - [ ] Update time estimations if needed

- [ ] **7. Final Verification**
  - [ ] Run ALL tests: `npm run test:unit && npm run test:integration && npm run test:e2e`
  - [ ] All tests pass ‚úÖ
  - [ ] All snapshots are up to date ‚úÖ
  - [ ] Test documentation is updated ‚úÖ
  - [ ] Ready to commit ‚úÖ

---

## Overview

This rule ensures that tests (Unit, Integration, E2E, and **Snapshot**) are automatically updated when working on features or bugs, and that new features include comprehensive test plans.

**‚ö†Ô∏è CRITICAL**: This checklist is MANDATORY for ALL code changes. No exceptions.

## When Working on Features

### 1. **Before Starting Development** ‚úÖ

- [ ] **Check existing test tasks**: Review `Rest/markdown/docs/testing/tasks/TASK_INDEX.md` to see if tests exist for the feature
- [ ] **If tests exist**: Review the test task file to understand test requirements
- [ ] **If tests don't exist**: Create a new test task file following the pattern in `Rest/markdown/docs/testing/tasks/`
- [ ] **Identify test files**: Find all related test files (unit, integration, E2E, snapshot)

### 2. **During Development** ‚úÖ

- [ ] **Update test tasks**: As you implement features, update the corresponding test task file with:
  - Implementation notes
  - Edge cases discovered
  - API changes
  - Component changes
- [ ] **Write tests alongside code**: Follow TDD principles when possible
- [ ] **Update test specifications**: Modify test assertions if requirements change
- [ ] **Update snapshots incrementally**: Update snapshots as UI changes occur

### 3. **After Feature Completion** ‚úÖ

- [ ] **Implement all test levels**: Ensure Unit, Integration, and E2E tests are written
- [ ] **Update snapshot tests**: Add/update snapshots for all component states
- [ ] **Update test task status**: Mark tests as implemented in the task file
- [ ] **Update TASK_INDEX.md**: Update the status of the test task
- [ ] **Run all tests**: Verify all tests pass before marking feature complete
- [ ] **Update snapshots**: Run `npm run test:unit -- --updateSnapshot` if UI changed

## When Working on Bugs

### 1. **Before Fixing** ‚úÖ

- [ ] **Identify affected tests**: Check which tests cover the buggy functionality
- [ ] **Review test task**: Look at the relevant test task file to understand test coverage
- [ ] **Reproduce in tests**: Write a failing test that reproduces the bug
- [ ] **Check snapshots**: Review snapshot tests that might be affected

### 2. **During Fix** ‚úÖ

- [ ] **Fix the bug**: Implement the fix
- [ ] **Update tests**: Ensure the failing test now passes
- [ ] **Add regression tests**: Add tests to prevent the bug from recurring
- [ ] **Update snapshots**: Update snapshots if UI/structure changed due to fix
- [ ] **Update test task**: Add notes about the bug and fix to the test task file

### 3. **After Fix** ‚úÖ

- [ ] **Verify all tests pass**: Run the full test suite (unit, integration, E2E)
- [ ] **Verify snapshots**: Run snapshot tests and update if needed
- [ ] **Update test documentation**: Document the bug fix in the test task file
- [ ] **Check related tests**: Ensure related functionality still works
- [ ] **Update snapshots**: Run `npm run test:unit -- --updateSnapshot` if UI changed

## When Creating New Features

### 1. **Feature Planning Phase**

- **Create test task file**: Before implementing, create a test task file in `Rest/markdown/docs/testing/tasks/`
- **Define test strategy**: Include Unit, Integration, and E2E test specifications
- **Estimate test time**: Add time estimations for manual and automated testing
- **Update TASK_INDEX.md**: Add the new test task to the index

### 2. **Feature Implementation Phase**

- **Follow test task**: Use the test task file as a guide for implementation
- **Write tests incrementally**: Write tests as you implement features
- **Update test task**: Add implementation notes and discoveries

### 3. **Feature Completion Phase**

- **Complete all tests**: Ensure all test levels are implemented
- **Update test status**: Mark tests as complete in the task file
- **Update comprehensive test plan**: Update `COMPREHENSIVE_TEST_PLAN.md` if needed

## Test Task File Structure

Each test task file should follow this structure:

```markdown
# Task: [Feature Name]

## Time Estimation
- Manual Testing: X-Y minutes
- Automated Testing: X-Y minutes (first run), X-Y minutes (subsequent)

## Overview
Brief description of what is being tested

## Manual Testing Steps
1. Step 1
2. Step 2
...

## Automated Tests

### Unit Tests
- **UT-XXX**: Test description
  - File: path/to/test.file
  - Assertions: ...
  - Status: ‚è≥ Pending / ‚úÖ Implemented

### Integration Tests
- **IT-XXX**: Test description
  - File: path/to/test.file
  - Assertions: ...
  - Status: ‚è≥ Pending / ‚úÖ Implemented

### E2E Tests
- **E2E-XXX**: Test description
  - File: path/to/test.file
  - Steps: ...
  - Status: ‚è≥ Pending / ‚úÖ Implemented
```

## Automatic Test Update Triggers

### Code Changes That Require Test Updates ‚ö†Ô∏è **MANDATORY**

1. **Component Changes** ‚Üí **Update ALL test types**
   - Props added/removed ‚Üí Update component tests + **snapshots**
   - State management changes ‚Üí Update integration tests + **snapshots**
   - UI changes ‚Üí Update E2E tests + **snapshots**
   - Styling changes ‚Üí **Update snapshots** (if visual output changed)

2. **API Changes** ‚Üí **Update Integration & E2E tests**
   - New endpoints ‚Üí Add API tests
   - Changed responses ‚Üí Update integration tests + **snapshots** (if UI affected)
   - Error handling changes ‚Üí Update error tests + **snapshots**

3. **Route Changes** ‚Üí **Update E2E & Integration tests**
   - New routes ‚Üí Add navigation tests + **snapshots**
   - Route parameter changes ‚Üí Update route tests + **snapshots**
   - Redirect changes ‚Üí Update redirect tests + **snapshots**

4. **Feature Additions** ‚Üí **Create ALL test types**
   - New features ‚Üí Create new test tasks (Unit, Integration, E2E, **Snapshot**)
   - Feature modifications ‚Üí Update existing test tasks + **snapshots**
   - Feature removals ‚Üí Mark tests as deprecated

5. **Bug Fixes** ‚Üí **Update ALL test types**
   - Bug fixes ‚Üí Add regression tests + **update snapshots**
   - Edge case fixes ‚Üí Update edge case tests + **snapshots**
   - Error handling fixes ‚Üí Update error tests + **snapshots**

6. **UI/Visual Changes** ‚Üí **MANDATORY Snapshot Updates**
   - Layout changes ‚Üí **Update snapshots**
   - Styling changes ‚Üí **Update snapshots**
   - Component structure changes ‚Üí **Update snapshots**
   - New UI states ‚Üí **Add snapshot tests**

## Test Update Workflow (MANDATORY)

### Step 1: Identify Affected Tests ‚úÖ

```bash
# Search for related test files
grep -r "feature-name" Rest/markdown/docs/testing/tasks/
grep -r "ComponentName" **/*.test.{ts,tsx}
grep -r "ComponentName" **/*.integration.test.{ts,tsx}
grep -r "ComponentName" **/*.spec.{ts,tsx}
grep -r "ComponentName" **/__snapshots__/**/*.snap
```

### Step 2: Review Test Task ‚úÖ

- [ ] Open the relevant test task file
- [ ] Review test specifications
- [ ] Identify what needs updating (Unit, Integration, E2E, **Snapshot**)

### Step 3: Update Tests ‚úÖ

- [ ] Update unit test files
- [ ] Update integration test files
- [ ] Update E2E test files
- [ ] **Update snapshot tests** (if UI/structure changed)
- [ ] Update test task file with notes
- [ ] Update TASK_INDEX.md if status changes

### Step 4: Update Snapshots ‚úÖ **REQUIRED**

```bash
# Update snapshots for specific test file
npm run test:unit -- path/to/test.file --updateSnapshot

# Update all snapshots
npm run test:unit -- --updateSnapshot

# Review snapshot changes before committing
git diff **/__snapshots__/**/*.snap
```

### Step 5: Verify Tests ‚úÖ

```bash
# Run affected tests
npm run test:unit -- path/to/test.file
npm run test:integration -- path/to/test.file
npm run test:e2e -- path/to/test.spec.ts

# Run all tests (including snapshots)
npm run test:unit && npm run test:integration && npm run test:e2e
```

## Test Maintenance Guidelines

### Regular Maintenance

- **Weekly**: Review pending tests in TASK_INDEX.md
- **Monthly**: Update time estimations based on actual test times
- **Quarterly**: Review and update comprehensive test plan

### Test Quality Checks

- **Coverage**: Ensure all features have test coverage
- **Completeness**: Ensure all test levels (Unit, Integration, E2E) are implemented
- **Currency**: Ensure tests reflect current implementation
- **Parallel Execution**: Ensure all tests can run in parallel

## AI Assistant Guidelines

When working with the AI assistant:

1. **Always mention test updates**: When requesting feature changes, mention that tests should be updated
2. **Always mention snapshot updates**: When requesting UI/structure changes, mention that snapshots should be updated
3. **Reference test tasks**: Reference specific test task files when discussing features
4. **Request test creation**: When creating new features, request test task creation (including snapshots)
5. **Verify test status**: After changes, verify test status in TASK_INDEX.md
6. **Run checklist**: Always follow the mandatory checklist above

## Snapshot Testing Guidelines ‚ö†Ô∏è **NEW - REQUIRED**

### When to Update Snapshots

- ‚úÖ **UI Changes**: Any visual/styling changes require snapshot updates
- ‚úÖ **Component Structure**: Changes to component structure require snapshot updates
- ‚úÖ **New Components**: New components require new snapshot tests
- ‚úÖ **State Changes**: Different component states should have snapshots
- ‚úÖ **Bug Fixes**: UI bug fixes may require snapshot updates

### Snapshot Test Locations

- Unit test files: `**/*.test.{ts,tsx}` (snapshot tests in same file)
- Snapshot files: `**/__snapshots__/**/*.snap` (auto-generated by Jest)

### Snapshot Update Commands

```bash
# Update snapshots for a specific test file
npm run test:unit -- apps/website/src/app/page.test.tsx --updateSnapshot

# Update all snapshots
npm run test:unit -- --updateSnapshot

# Review snapshot changes
git diff **/__snapshots__/**/*.snap

# Run tests without updating snapshots (to see failures)
npm run test:unit -- --no-updateSnapshot
```

### Snapshot Test Best Practices

- ‚úÖ **Review changes carefully**: Don't blindly accept all snapshot changes
- ‚úÖ **Test multiple states**: Create snapshots for default, loading, error, empty, populated states
- ‚úÖ **Commit snapshots**: Snapshot files should be committed to Git
- ‚úÖ **Update intentionally**: Only update snapshots when UI changes are intentional
- ‚ùå **Don't ignore failures**: Snapshot failures indicate UI changes that need review

## Examples

### Example 1: Adding a New Feature

```
User: "Add a new filter to the flashcards page"

AI should:
1. ‚úÖ Check if test task exists for flashcards (F-007)
2. ‚úÖ Review the test task file
3. ‚úÖ Suggest updating the test task to include the new filter
4. ‚úÖ Update test specifications (Unit, Integration, E2E)
5. ‚úÖ **Add/update snapshot tests for the new filter UI**
6. ‚úÖ Implement the feature with tests
7. ‚úÖ Run all tests including snapshots
8. ‚úÖ Update snapshots: `npm run test:unit -- --updateSnapshot`
```

### Example 2: Fixing a Bug

```
User: "Fix the navigation link not working on mobile"

AI should:
1. ‚úÖ Identify affected test (S-001: Navigation Component)
2. ‚úÖ Review the test task file
3. ‚úÖ Add a failing test that reproduces the bug
4. ‚úÖ Fix the bug
5. ‚úÖ Verify the test passes
6. ‚úÖ **Update snapshots if UI changed**
7. ‚úÖ Update the test task with bug fix notes
```

### Example 3: Updating a Component

```
User: "Update the QuestionCard to show difficulty badge"

AI should:
1. ‚úÖ Identify affected test (S-002: Question Card Component)
2. ‚úÖ Review the test task file
3. ‚úÖ Update test specifications to include difficulty badge
4. ‚úÖ Update component tests (Unit, Integration, E2E)
5. ‚úÖ **Update snapshot tests** (UI changed - badge added)
6. ‚úÖ Run: `npm run test:unit -- apps/website/src/components/QuestionDisplay.test.tsx --updateSnapshot`
7. ‚úÖ Update the test task file
```

### Example 4: UI/Styling Changes

```
User: "Change the button color from blue to red"

AI should:
1. ‚úÖ Identify affected components and test files
2. ‚úÖ Update component code
3. ‚úÖ **MANDATORY: Update snapshot tests** (visual change)
4. ‚úÖ Run: `npm run test:unit -- --updateSnapshot`
5. ‚úÖ Review snapshot changes to ensure they're correct
6. ‚úÖ Verify all tests pass
```

## File Locations

- **Test Tasks**: `Rest/markdown/docs/testing/tasks/`
- **Test Index**: `Rest/markdown/docs/testing/tasks/TASK_INDEX.md`
- **Comprehensive Plan**: `Rest/markdown/docs/testing/COMPREHENSIVE_TEST_PLAN.md`
- **Time Estimations**: `Rest/markdown/docs/testing/tasks/TIME_ESTIMATIONS_SUMMARY.md`
- **Test Files**: `**/*.test.{ts,tsx}`, `**/*.spec.{ts,tsx}`, `**/*.integration.test.{ts,tsx}`

## Status Indicators

- ‚úÖ **Implemented**: Test is written and passing
- ‚è≥ **Pending**: Test is planned but not yet implemented
- üîÑ **In Progress**: Test is being developed
- ‚ùå **Failing**: Test exists but is currently failing
- ‚è∏Ô∏è **Skipped**: Test is temporarily skipped
- üóëÔ∏è **Deprecated**: Test is no longer relevant

## Quick Reference Commands

```bash
# List all test tasks
cat Rest/markdown/docs/testing/tasks/TASK_INDEX.md

# Find test task for a feature
grep -r "feature-name" Rest/markdown/docs/testing/tasks/

# Run all tests
npm run test:unit && npm run test:integration && npm run test:e2e

# Run tests for a specific flow
npm run test:unit:freestyle-flow
npm run test:integration:admin
npm run test:e2e:guided-flow

# SNAPSHOT COMMANDS (REQUIRED FOR UI CHANGES)
# Update snapshots for specific test
npm run test:unit -- path/to/test.file --updateSnapshot

# Update all snapshots
npm run test:unit -- --updateSnapshot

# Review snapshot changes
git diff **/__snapshots__/**/*.snap

# Run tests without updating (to see failures)
npm run test:unit -- --no-updateSnapshot
```

---

## üö® **CRITICAL REMINDERS**

1. **EVERY code change requires test updates** - No exceptions
2. **UI changes REQUIRE snapshot updates** - Mandatory
3. **Follow the checklist** - It's there for a reason
4. **Run all tests before committing** - Don't skip this
5. **Review snapshot changes** - Don't blindly accept all changes
6. **Update test documentation** - Keep it current

---

**Remember**: Tests (Unit, Integration, E2E, and **Snapshots**) are not just for verification‚Äîthey are documentation, regression prevention, and design tools. Keep them updated and comprehensive!

**‚ö†Ô∏è This checklist is MANDATORY. Always complete it before committing any code changes.**
