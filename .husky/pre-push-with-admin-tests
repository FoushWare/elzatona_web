#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸš€ PRE-PUSH HOOK STARTING..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "ğŸ“ Current branch: $current_branch"
echo ""

# Only run comprehensive checks on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "ğŸ”„ Running pre-push checks on development branch..."
  echo ""
  
  # Step 1: Build check
  echo "ğŸ—ï¸  STEP 1: Running build validation..."
  echo "   ğŸ“¦ Executing: npm run build"
  echo "   â³ This may take a moment..."
  echo ""
  
  # Run build with detailed output
  npm run build
  BUILD_EXIT_CODE=$?
  
  echo ""
  if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "   âŒ Build failed with exit code: $BUILD_EXIT_CODE"
    echo "   ğŸ’¡ Please fix build issues before pushing"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ PRE-PUSH HOOK FAILED - BUILD ERRORS DETECTED!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  else
    echo "   âœ… Build completed successfully!"
  fi
  echo ""
  
  # Step 2: Run comprehensive admin login tests
  echo "ğŸ§ª STEP 2: Running comprehensive admin login tests..."
  echo "   ğŸ“ Executing: npm run test:admin-login"
  echo "   ğŸ” Running all admin authentication tests"
  echo ""
  
  # Check if admin tests exist
  if [ -f "tests/admin/admin-login-api.test.ts" ]; then
    npm run test:admin-login
    TEST_EXIT_CODE=$?
    
    if [ $TEST_EXIT_CODE -ne 0 ]; then
      echo "   âŒ Admin login tests failed with exit code: $TEST_EXIT_CODE"
      echo "   ğŸ’¡ Please fix admin authentication issues before pushing"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ PRE-PUSH HOOK FAILED - ADMIN LOGIN TESTS FAILED!"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      exit 1
    else
      echo "   âœ… Admin login tests passed successfully!"
    fi
  else
    echo "   â„¹ï¸  Admin login tests not found, skipping..."
  fi
  echo ""
  
  # Step 3: Clean up build files after successful build
  echo "ğŸ§¹ STEP 3: Cleaning build files..."
  
  echo "   ğŸ—‘ï¸  Removing .next directory..."
  if [ -d ".next" ]; then
    rm -rf .next
    echo "   âœ… .next directory removed"
  else
    echo "   â„¹ï¸  .next directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing build directory..."
  if [ -d "build" ]; then
    rm -rf build
    echo "   âœ… build directory removed"
  else
    echo "   â„¹ï¸  build directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing storybook-static directory..."
  if [ -d "storybook-static" ]; then
    rm -rf storybook-static
    echo "   âœ… storybook-static directory removed"
  else
    echo "   â„¹ï¸  storybook-static directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing test-results directory..."
  if [ -d "test-results" ]; then
    rm -rf test-results
    echo "   âœ… test-results directory removed"
  else
    echo "   â„¹ï¸  test-results directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing coverage directory..."
  if [ -d "coverage" ]; then
    rm -rf coverage
    echo "   âœ… coverage directory removed"
  else
    echo "   â„¹ï¸  coverage directory not found (already clean)"
  fi
  
  echo "   â„¹ï¸  Keeping tsconfig.tsbuildinfo (helps with incremental builds)"
  echo ""
  
  # Step 4: Final status
  echo "ğŸ“Š PRE-PUSH SUMMARY:"
  echo "   âœ… Build validation passed"
  echo "   âœ… Admin login tests passed"
  echo "   âœ… Build files cleaned"
  echo "   âœ… Ready for push"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âœ… PRE-PUSH CHECKS COMPLETED SUCCESSFULLY!"
  echo "ğŸš€ READY TO PUSH TO REMOTE REPOSITORY!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
else
  echo "â„¹ï¸  Branch '$current_branch' is not a development branch"
  echo "ğŸ’¡ Pre-push checks only run on: main, develop, release/v1.0.0-main-website"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "â„¹ï¸  PRE-PUSH HOOK SKIPPED (Non-development branch)"
  echo "ğŸš€ READY TO PUSH!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
fi
