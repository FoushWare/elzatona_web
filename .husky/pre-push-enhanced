#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸš€ PRE-PUSH HOOK STARTING (Nx Monorepo Enhanced)..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "ğŸ“ Current branch: $current_branch"
echo ""

# Only run build check on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "ğŸ”„ Running pre-push checks on development branch..."
  echo ""
  
  # Step 1: Check what changed to determine what to build
  echo "ğŸ” STEP 1: Analyzing changes..."
  echo "   ğŸ“Š Checking affected projects..."
  
  # Get affected projects (if nx affected works)
  AFFECTED_PROJECTS=$(npx nx show projects --affected --base=HEAD~1 2>/dev/null || echo "web,admin")
  echo "   ğŸ“¦ Affected projects: $AFFECTED_PROJECTS"
  echo ""
  
  # Step 2: Build affected projects
  echo "ğŸ—ï¸  STEP 2: Building affected projects..."
  
  if [[ "$AFFECTED_PROJECTS" == *"web"* ]] || [[ "$AFFECTED_PROJECTS" == "web,admin" ]]; then
    echo "   ğŸ“¦ Building web app..."
    echo "   ğŸ”§ Executing: npx nx build web"
    
    npx nx build web
    WEB_BUILD_EXIT_CODE=$?
    
    if [ $WEB_BUILD_EXIT_CODE -ne 0 ]; then
      echo "   âŒ Web app build failed with exit code: $WEB_BUILD_EXIT_CODE"
      echo "   ğŸ’¡ Please fix web app build issues before pushing"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ PRE-PUSH HOOK FAILED - WEB BUILD ERRORS DETECTED!"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      exit 1
    else
      echo "   âœ… Web app build completed successfully!"
    fi
  else
    echo "   â„¹ï¸  Web app not affected, skipping build"
  fi
  
  if [[ "$AFFECTED_PROJECTS" == *"admin"* ]] || [[ "$AFFECTED_PROJECTS" == "web,admin" ]]; then
    echo "   ğŸ“¦ Building admin app..."
    echo "   ğŸ”§ Executing: npx nx build admin"
    
    npx nx build admin
    ADMIN_BUILD_EXIT_CODE=$?
    
    if [ $ADMIN_BUILD_EXIT_CODE -ne 0 ]; then
      echo "   âŒ Admin app build failed with exit code: $ADMIN_BUILD_EXIT_CODE"
      echo "   ğŸ’¡ Please fix admin app build issues before pushing"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ PRE-PUSH HOOK FAILED - ADMIN BUILD ERRORS DETECTED!"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      exit 1
    else
      echo "   âœ… Admin app build completed successfully!"
    fi
  else
    echo "   â„¹ï¸  Admin app not affected, skipping build"
  fi
  
  echo ""
  
  # Step 3: Run affected tests (optional, can be enabled)
  echo "ğŸ§ª STEP 3: Running affected tests..."
  echo "   â„¹ï¸  Test execution disabled for faster commits"
  echo "   ğŸ’¡ Enable by uncommenting the test commands below"
  echo ""
  
  # Uncomment these lines to enable testing in pre-push
  # echo "   ğŸ”§ Executing: npx nx test --affected"
  # npx nx test --affected
  # TEST_EXIT_CODE=$?
  # if [ $TEST_EXIT_CODE -ne 0 ]; then
  #   echo "   âŒ Tests failed"
  #   exit 1
  # fi
  
  # Step 4: Clean up build files after successful build (Nx structure)
  echo "ğŸ§¹ STEP 4: Cleaning build files..."
  
  echo "   ğŸ—‘ï¸  Removing apps/web/.next directory..."
  if [ -d "apps/web/.next" ]; then
    rm -rf apps/web/.next
    echo "   âœ… apps/web/.next directory removed"
  else
    echo "   â„¹ï¸  apps/web/.next directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing apps/admin/.next directory..."
  if [ -d "apps/admin/.next" ]; then
    rm -rf apps/admin/.next
    echo "   âœ… apps/admin/.next directory removed"
  else
    echo "   â„¹ï¸  apps/admin/.next directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing dist directory..."
  if [ -d "dist" ]; then
    rm -rf dist
    echo "   âœ… dist directory removed"
  else
    echo "   â„¹ï¸  dist directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing nx cache temp files..."
  if [ -d "tmp" ]; then
    rm -rf tmp
    echo "   âœ… tmp directory removed"
  else
    echo "   â„¹ï¸  tmp directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing storybook-static directory..."
  if [ -d "storybook-static" ]; then
    rm -rf storybook-static
    echo "   âœ… storybook-static directory removed"
  else
    echo "   â„¹ï¸  storybook-static directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing test-results directory..."
  if [ -d "test-results" ]; then
    rm -rf test-results
    echo "   âœ… test-results directory removed"
  else
    echo "   â„¹ï¸  test-results directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing coverage directory..."
  if [ -d "coverage" ]; then
    rm -rf coverage
    echo "   âœ… coverage directory removed"
  else
    echo "   â„¹ï¸  coverage directory not found (already clean)"
  fi
  
  echo "   â„¹ï¸  Keeping .nx cache for faster future builds"
  echo "   â„¹ï¸  Keeping tsconfig.tsbuildinfo (helps with incremental builds)"
  echo ""
  
  # Step 5: Final status
  echo "ğŸ“Š PRE-PUSH SUMMARY:"
  echo "   âœ… Affected projects analyzed"
  echo "   âœ… Build validation passed for all affected apps"
  echo "   âœ… Build files cleaned"
  echo "   âœ… Nx cache preserved for performance"
  echo "   âœ… Ready for push"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âœ… PRE-PUSH CHECKS COMPLETED SUCCESSFULLY!"
  echo "ğŸš€ READY TO PUSH TO REMOTE REPOSITORY!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
else
  echo "â„¹ï¸  Branch '$current_branch' is not a development branch"
  echo "ğŸ’¡ Pre-push checks only run on: main, develop, release/v1.0.0-main-website"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "â„¹ï¸  PRE-PUSH HOOK SKIPPED (Non-development branch)"
  echo "ğŸš€ READY TO PUSH!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
fi
