#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ” PRE-COMMIT HOOK (Fastest Checks)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Run Prettier formatting
echo "ğŸ¨ STEP 1: Running Prettier formatting..."
echo "   ğŸ“ Executing: npm run format"
echo ""

npm run format
PRETTIER_EXIT_CODE=$?

if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
  echo "   âŒ Prettier formatting failed with exit code: $PRETTIER_EXIT_CODE"
  echo "   ğŸ’¡ Please fix formatting issues before committing"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âŒ PRE-COMMIT HOOK FAILED - FORMATTING ERRORS DETECTED!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
else
  echo "   âœ… Prettier formatting completed successfully!"
fi
echo ""

# Step 2: Secret scanning with GitGuardian (ggshield)
echo "ğŸ”’ STEP 2: Running GitGuardian secret scanning on staged files..."
echo "   ğŸ“ Executing: ggshield secret scan pre-commit"
echo "   âš ï¸  This will catch secrets BEFORE they leave your machine!"
echo ""

# Load GitGuardian API key from .env.local if available
if [ -f .env.local ] && [ -z "$GITGUARDIAN_API_KEY" ]; then
  # Extract GITGUARDIAN_API_KEY from .env.local (handle comments and empty lines)
  export GITGUARDIAN_API_KEY=$(grep -E "^GITGUARDIAN_API_KEY=" .env.local 2>/dev/null | cut -d '=' -f2- | tr -d '"' | tr -d "'" | xargs)
fi

# Check if ggshield is available
if ! command -v ggshield &> /dev/null; then
  echo "   âš ï¸  GitGuardian CLI (ggshield) not found"
  echo "   ğŸ’¡ Install with: pipx install ggshield"
  echo "   ğŸ’¡ Or: brew install ggshield"
  echo "   â­ï¸  Skipping secret scan (pre-push hook will still scan)"
  echo ""
else
  # Run ggshield on staged files
  # Capture both stdout and stderr to check for auth errors
  GGSHIELD_OUTPUT=$(ggshield secret scan pre-commit 2>&1)
  GGSHIELD_EXIT_CODE=$?
  
  # Check if the error is due to missing authentication
  if echo "$GGSHIELD_OUTPUT" | grep -q "A GitGuardian API key is needed"; then
    echo "   âš ï¸  GitGuardian is not authenticated"
    echo "   ğŸ’¡ To set up authentication:"
    echo "      1. Add GITGUARDIAN_API_KEY to .env.local"
    echo "      2. Or run: ggshield auth login"
    echo "   â­ï¸  Allowing commit (pre-push hook will still scan for secrets)"
    echo "   ğŸ“š Setup guide: https://docs.gitguardian.com/ggshield-docs/reference/auth/login"
    echo ""
  elif [ $GGSHIELD_EXIT_CODE -ne 0 ]; then
    echo "$GGSHIELD_OUTPUT"
    echo ""
    echo "   âŒ GitGuardian detected secrets in staged files!"
    echo "   ğŸ’¡ Please remove hardcoded secrets and use environment variables"
    echo "   ğŸ’¡ See: https://docs.gitguardian.com/ggshield-docs/getting-started"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ PRE-COMMIT HOOK FAILED - SECRETS DETECTED!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  else
    echo "   âœ… GitGuardian secret scan passed - no secrets detected!"
  fi
fi
echo ""

# Step 3: CodeQL security analysis (optional - can be disabled with SKIP_CODEQL=1)
if [ "$SKIP_CODEQL" != "1" ]; then
  echo "ğŸ” STEP 3: Running CodeQL security analysis..."
  echo "   ğŸ“ Executing: libs/utilities/scripts/check-codeql-precommit.sh"
  echo "   âš ï¸  This will catch security vulnerabilities BEFORE commit!"
  echo "   ğŸ’¡ To skip: SKIP_CODEQL=1 git commit"
  echo ""

  # Check if CodeQL script exists
  if [ -f "libs/utilities/scripts/check-codeql-precommit.sh" ]; then
    bash libs/utilities/scripts/check-codeql-precommit.sh
    CODEQL_EXIT_CODE=$?
    
    if [ $CODEQL_EXIT_CODE -ne 0 ]; then
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ PRE-COMMIT HOOK FAILED - CODEQL SECURITY ISSUES DETECTED!"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ’¡ The auto-fix script may have fixed some issues."
      echo "ğŸ’¡ Please review the changes and stage them:"
      echo "   git add -A"
      echo "   git commit"
      echo ""
      echo "ğŸ’¡ If issues persist, fix them manually or skip with:"
      echo "   SKIP_CODEQL=1 git commit (NOT RECOMMENDED)"
      echo ""
      exit 1
    else
      echo "   âœ… CodeQL security analysis passed!"
    fi
  else
    echo "   âš ï¸  CodeQL check script not found"
    echo "   ğŸ’¡ Skipping CodeQL check"
  fi
  echo ""
else
  echo "â­ï¸  STEP 3: Skipping CodeQL check (SKIP_CODEQL=1)"
  echo ""
fi

# Step 4: Add formatted files to staging
echo "ğŸ“¦ STEP 4: Adding formatted files to staging..."
git add .
echo "   âœ… Formatted files added to staging"
echo ""

# Final status
echo "ğŸ“Š PRE-COMMIT SUMMARY:"
echo "   âœ… Prettier formatting completed"
echo "   âœ… GitGuardian secret scanning passed"
echo "   âœ… CodeQL security analysis passed"
echo "   âœ… Files staged for commit"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRE-COMMIT CHECKS COMPLETED SUCCESSFULLY!"
echo "ğŸš€ READY TO COMMIT!"
echo ""
echo "ğŸ’¡ Note: Linting, type checking, and build validation"
echo "   will run on push (before code reaches GitHub)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
