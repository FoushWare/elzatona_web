#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ” PRE-COMMIT HOOK (Fast Checks - All Local)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Run Prettier formatting
echo "ğŸ¨ STEP 1: Running Prettier formatting..."
echo "   ğŸ“ Executing: npm run format"
echo ""

npm run format
PRETTIER_EXIT_CODE=$?

if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
  echo "   âŒ Prettier formatting failed with exit code: $PRETTIER_EXIT_CODE"
  echo "   ğŸ’¡ Please fix formatting issues before committing"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âŒ PRE-COMMIT HOOK FAILED - FORMATTING ERRORS DETECTED!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
else
  echo "   âœ… Prettier formatting completed successfully!"
fi
echo ""

# Step 2: ESLint with auto-fix (fast check)
echo "ğŸ” STEP 2: Running ESLint with auto-fix..."
echo "   ğŸ“ Executing: npm run lint:fix"
echo ""

npm run lint:fix
LINT_FIX_EXIT_CODE=$?

if [ $LINT_FIX_EXIT_CODE -ne 0 ]; then
  echo "   âš ï¸  ESLint auto-fix completed with warnings"
  echo "   ğŸ’¡ Some issues may require manual fixes"
else
  echo "   âœ… ESLint auto-fix completed successfully!"
fi
echo ""

# Step 3: TypeScript type checking (fast - only staged files)
echo "ğŸ“˜ STEP 3: Running TypeScript type checking..."
echo "   ğŸ“ Executing: npm run type-check"
echo "   â³ This may take a moment..."
echo ""

NODE_OPTIONS="--max-old-space-size=2048" npm run type-check
TS_EXIT_CODE=$?

if [ $TS_EXIT_CODE -ne 0 ]; then
  echo "   âŒ TypeScript type checking failed"
  echo "   ğŸ’¡ Please fix TypeScript errors before committing"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âŒ PRE-COMMIT HOOK FAILED - TYPESCRIPT ERRORS DETECTED!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
else
  echo "   âœ… TypeScript type checking passed!"
fi
echo ""

# Step 4: Build check (fast - catches compilation errors)
echo "ğŸ—ï¸  STEP 4: Running build validation..."
echo "   ğŸ“¦ Executing: npm run build"
echo "   â³ This may take a moment..."
echo ""

NODE_OPTIONS="--max-old-space-size=2048" NEXT_TELEMETRY_DISABLED=1 npm run build
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "   âŒ Build failed"
  echo "   ğŸ’¡ Please fix build errors before committing"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âŒ PRE-COMMIT HOOK FAILED - BUILD ERRORS DETECTED!"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  exit 1
else
  echo "   âœ… Build validation passed!"
fi
echo ""

# Step 5: Secret scanning with GitGuardian (ggshield)
echo "ğŸ”’ STEP 5: Running GitGuardian secret scanning on staged files..."
echo "   ğŸ“ Executing: ggshield secret scan pre-commit"
echo "   âš ï¸  This will catch secrets BEFORE they leave your machine!"
echo ""

# Load GitGuardian API key from .env.local if available
if [ -f .env.local ] && [ -z "$GITGUARDIAN_API_KEY" ]; then
  export GITGUARDIAN_API_KEY=$(grep -E "^GITGUARDIAN_API_KEY=" .env.local 2>/dev/null | cut -d '=' -f2- | tr -d '"' | tr -d "'" | xargs)
fi

# Check if ggshield is available
if ! command -v ggshield &> /dev/null; then
  echo "   âš ï¸  GitGuardian CLI (ggshield) not found"
  echo "   ğŸ’¡ Install with: pipx install ggshield"
  echo "   ğŸ’¡ Or: brew install ggshield"
  echo "   â­ï¸  Skipping secret scan (pre-push hook will still scan)"
  echo ""
else
  GGSHIELD_OUTPUT=$(ggshield secret scan pre-commit 2>&1)
  GGSHIELD_EXIT_CODE=$?
  
  if echo "$GGSHIELD_OUTPUT" | grep -q "A GitGuardian API key is needed"; then
    echo "   âš ï¸  GitGuardian is not authenticated"
    echo "   ğŸ’¡ To set up authentication:"
    echo "      1. Add GITGUARDIAN_API_KEY to .env.local"
    echo "      2. Or run: ggshield auth login"
    echo "   â­ï¸  Allowing commit (pre-push hook will still scan for secrets)"
    echo ""
  elif [ $GGSHIELD_EXIT_CODE -ne 0 ]; then
    echo "$GGSHIELD_OUTPUT"
    echo ""
    echo "   âŒ GitGuardian detected secrets in staged files!"
    echo "   ğŸ’¡ Please remove hardcoded secrets and use environment variables"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ PRE-COMMIT HOOK FAILED - SECRETS DETECTED!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  else
    echo "   âœ… GitGuardian secret scan passed - no secrets detected!"
  fi
fi
echo ""

# Step 6: CodeQL security analysis (optional - can be disabled with SKIP_CODEQL=1)
if [ "$SKIP_CODEQL" != "1" ]; then
  echo "ğŸ” STEP 6: Running CodeQL security analysis..."
  echo "   ğŸ“ Executing: libs/utilities/scripts/check-codeql-precommit.sh"
  echo "   âš ï¸  This will catch security vulnerabilities BEFORE commit!"
  echo "   ğŸ’¡ To skip: SKIP_CODEQL=1 git commit"
  echo ""

  if [ -f "libs/utilities/scripts/check-codeql-precommit.sh" ]; then
    bash libs/utilities/scripts/check-codeql-precommit.sh
    CODEQL_EXIT_CODE=$?
    
    if [ $CODEQL_EXIT_CODE -ne 0 ]; then
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ PRE-COMMIT HOOK FAILED - CODEQL SECURITY ISSUES DETECTED!"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ğŸ’¡ The auto-fix script may have fixed some issues."
      echo "ğŸ’¡ Please review the changes and stage them:"
      echo "   git add -A"
      echo "   git commit"
      echo ""
      exit 1
    else
      echo "   âœ… CodeQL security analysis passed!"
    fi
  else
    echo "   âš ï¸  CodeQL check script not found"
    echo "   ğŸ’¡ Skipping CodeQL check"
  fi
  echo ""
else
  echo "â­ï¸  STEP 6: Skipping CodeQL check (SKIP_CODEQL=1)"
  echo ""
fi

# Step 7: SonarQube code quality analysis (optional - can be disabled with SKIP_SONAR=1)
if [ "$SKIP_SONAR" != "1" ] && [ -n "$SONAR_TOKEN" ]; then
  echo "ğŸ“Š STEP 7: Running SonarQube code quality analysis..."
  echo "   ğŸ“ Executing: npm run sonar:quick"
  echo "   âš ï¸  This will catch code quality issues BEFORE commit!"
  echo "   ğŸ’¡ To skip: SKIP_SONAR=1 git commit"
  echo ""

  npm run sonar:quick
  SONAR_EXIT_CODE=$?
  
  if [ $SONAR_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ PRE-COMMIT HOOK FAILED - SONARQUBE ISSUES DETECTED!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ’¡ Please review the SonarQube output above for details"
    echo "ğŸ’¡ Fix issues or skip with: SKIP_SONAR=1 git commit"
    echo ""
    exit 1
  else
    echo "   âœ… SonarQube code quality analysis passed!"
  fi
  echo ""
else
  if [ "$SKIP_SONAR" = "1" ]; then
    echo "â­ï¸  STEP 7: Skipping SonarQube check (SKIP_SONAR=1)"
  else
    echo "â­ï¸  STEP 7: Skipping SonarQube check (SONAR_TOKEN not set)"
  fi
  echo ""
fi

# Step 8: Add formatted and fixed files to staging
echo "ğŸ“¦ STEP 8: Adding formatted and fixed files to staging..."
git add .
echo "   âœ… Formatted and fixed files added to staging"
echo ""

# Final status
echo "ğŸ“Š PRE-COMMIT SUMMARY:"
echo "   âœ… Prettier formatting completed"
echo "   âœ… ESLint auto-fix completed"
echo "   âœ… TypeScript type checking passed"
echo "   âœ… Build validation passed"
echo "   âœ… GitGuardian secret scanning passed"
echo "   âœ… CodeQL security analysis passed"
echo "   âœ… SonarQube code quality analysis passed"
echo "   âœ… Files staged for commit"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRE-COMMIT CHECKS COMPLETED SUCCESSFULLY!"
echo "ğŸš€ READY TO COMMIT!"
echo ""
echo "ğŸ’¡ All checks run locally - CI/CD pipeline will be faster!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
