#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PRE-PUSH HOOK (Comprehensive Checks - All Local)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "๐ Current branch: $current_branch"
echo ""

# Run comprehensive checks on all branches (to catch issues before CI)
echo "๐ Running comprehensive pre-push checks..."
echo "   ๐ก All checks run locally to reduce CI/CD pipeline time"
echo ""

# Step 1: ESLint with auto-fix
echo "๐ STEP 1: Running ESLint with auto-fix..."
echo "   ๐ Executing: npm run lint:fix"
echo "   โณ This may take a moment..."
echo ""

npm run lint:fix
LINT_FIX_EXIT_CODE=$?

echo ""
if [ $LINT_FIX_EXIT_CODE -ne 0 ]; then
  echo "   โ๏ธ  ESLint auto-fix completed with warnings (exit code: $LINT_FIX_EXIT_CODE)"
  echo "   ๐ก Some issues may require manual fixes"
else
  echo "   โ ESLint auto-fix completed successfully!"
fi
echo ""

# Step 2: Run linting check (after auto-fix)
echo "๐ STEP 2: Running ESLint check (after auto-fix)..."
echo "   ๐ Executing: npm run lint"
echo "   โณ Checking for remaining linting issues..."
echo ""

npm run lint || true  # Allow warnings to pass
LINT_EXIT_CODE=$?

echo ""
if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "   โ๏ธ  ESLint found remaining issues (exit code: $LINT_EXIT_CODE)"
  echo "   ๐ก Please review and fix the remaining linting issues"
  echo "   ๐ง You can run 'npm run lint:fix' to auto-fix more issues"
  echo "   ๐ Allowing push to proceed (warnings only)"
else
  echo "   โ ESLint check passed successfully!"
fi
echo ""

# Step 3: TypeScript type checking (memory-optimized for 8GB RAM)
echo "๐ STEP 3: Running TypeScript type checking..."
echo "   ๐ Executing: npm run type-check"
echo "   โณ Checking for TypeScript errors..."
echo "   ๐พ Memory-optimized: Single-threaded mode"
echo ""

NODE_OPTIONS="--max-old-space-size=2048" npm run type-check
TS_EXIT_CODE=$?

echo ""
if [ $TS_EXIT_CODE -ne 0 ]; then
  echo "   โ TypeScript type checking failed with exit code: $TS_EXIT_CODE"
  echo "   ๐ก Please fix TypeScript errors before pushing"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โ PRE-PUSH HOOK FAILED - TYPESCRIPT ERRORS DETECTED!"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
  exit 1
else
  echo "   โ TypeScript type checking passed successfully!"
fi
echo ""

# Step 4: Build check (includes TypeScript compilation)
echo "๐๏ธ  STEP 4: Running build validation..."
echo "   ๐ฆ Executing: npm run build"
echo "   โณ This may take a moment..."
echo "   ๐ก This ensures code compiles before pushing to CI/CD"
echo "   ๐พ Memory-optimized: Single-threaded, limited memory usage"
echo ""

NODE_OPTIONS="--max-old-space-size=2048" NEXT_TELEMETRY_DISABLED=1 npm run build
BUILD_EXIT_CODE=$?

echo ""
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "   โ Build failed with exit code: $BUILD_EXIT_CODE"
  echo "   ๐ก Please fix build issues before pushing"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โ PRE-PUSH HOOK FAILED - BUILD ERRORS DETECTED!"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
  exit 1
else
  echo "   โ Build completed successfully!"
fi
echo ""

# Step 5: CodeQL security analysis (optional - can be disabled with SKIP_CODEQL=1)
if [ "$SKIP_CODEQL" != "1" ]; then
  echo "๐ STEP 5: Running CodeQL security analysis..."
  echo "   ๐ Executing: npm run codeql"
  echo "   โ๏ธ  This will catch security vulnerabilities BEFORE push!"
  echo "   ๐ก To skip: SKIP_CODEQL=1 git push"
  echo "   โณ This may take 5-15 minutes..."
  echo ""

  npm run codeql
  CODEQL_EXIT_CODE=$?
  
  if [ $CODEQL_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ PRE-PUSH HOOK FAILED - CODEQL SECURITY ISSUES DETECTED!"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "๐ก Review codeql-results.sarif for details"
    echo "๐ก Run 'npm run codeql:fix' to attempt auto-fixes"
    echo "๐ก Or skip with: SKIP_CODEQL=1 git push (NOT RECOMMENDED)"
    echo ""
    exit 1
  else
    echo "   โ CodeQL security analysis passed!"
  fi
  echo ""
else
  echo "โญ๏ธ  STEP 5: Skipping CodeQL check (SKIP_CODEQL=1)"
  echo ""
fi

# Step 6: SonarQube code quality analysis (optional - can be disabled with SKIP_SONAR=1)
if [ "$SKIP_SONAR" != "1" ] && [ -n "$SONAR_TOKEN" ]; then
  echo "๐ STEP 6: Running SonarQube code quality analysis..."
  echo "   ๐ Executing: npm run sonar:quick"
  echo "   โ๏ธ  This will catch code quality issues BEFORE push!"
  echo "   ๐ก To skip: SKIP_SONAR=1 git push"
  echo ""

  npm run sonar:quick
  SONAR_EXIT_CODE=$?
  
  if [ $SONAR_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ PRE-PUSH HOOK FAILED - SONARQUBE ISSUES DETECTED!"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "๐ก Please review the SonarQube output above for details"
    echo "๐ก Fix issues or skip with: SKIP_SONAR=1 git push"
    echo ""
    exit 1
  else
    echo "   โ SonarQube code quality analysis passed!"
  fi
  echo ""
else
  if [ "$SKIP_SONAR" = "1" ]; then
    echo "โญ๏ธ  STEP 6: Skipping SonarQube check (SKIP_SONAR=1)"
  else
    echo "โญ๏ธ  STEP 6: Skipping SonarQube check (SONAR_TOKEN not set)"
  fi
  echo ""
fi

# Step 7: Secret scanning on changed files (CRITICAL - prevents secrets from reaching GitHub)
echo "๐ STEP 7: Running secret scanning on changed files..."
echo "   ๐ This prevents secrets from reaching GitHub"
echo ""

if [ -f "scripts/pre-push-secret-scan.sh" ]; then
  bash scripts/pre-push-secret-scan.sh "$@"
  SECRET_SCAN_EXIT_CODE=$?
  
  if [ $SECRET_SCAN_EXIT_CODE -ne 0 ]; then
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ PRE-PUSH HOOK FAILED - SECRETS DETECTED!"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    exit 1
  fi
else
  echo "   โ๏ธ  Secret scanning script not found (scripts/pre-push-secret-scan.sh)"
  echo "   ๐ก Secret scanning is recommended for security"
fi
echo ""

# Step 8: Add auto-fixed files to staging
echo "๐ฆ STEP 8: Adding auto-fixed files to staging..."
git add .
echo "   โ Auto-fixed files added to staging"
echo ""

# Step 9: Clean up build files after successful build
echo "๐งน STEP 9: Cleaning build files..."
echo "   ๐๏ธ  Removing .next directory..."
if [ -d ".next" ]; then
  rm -rf .next
  echo "   โ .next directory removed"
else
  echo "   โน๏ธ  .next directory not found (already clean)"
fi

echo "   ๐๏ธ  Removing build directory..."
if [ -d "build" ]; then
  rm -rf build
  echo "   โ build directory removed"
else
  echo "   โน๏ธ  build directory not found (already clean)"
fi

echo "   ๐๏ธ  Removing storybook-static directory..."
if [ -d "storybook-static" ]; then
  rm -rf storybook-static
  echo "   โ storybook-static directory removed"
else
  echo "   โน๏ธ  storybook-static directory not found (already clean)"
fi

echo "   ๐๏ธ  Removing coverage directory..."
if [ -d "coverage" ]; then
  rm -rf coverage
  echo "   โ coverage directory removed"
else
  echo "   โน๏ธ  coverage directory not found (already clean)"
fi

echo "   ๐น Cleaning up Playwright test videos..."
if [ -f "libs/utilities/scripts/cleanup-playwright-videos.sh" ]; then
  bash libs/utilities/scripts/cleanup-playwright-videos.sh
  echo "   โ Playwright videos cleaned up"
else
  echo "   โน๏ธ  Cleanup script not found (non-critical)"
fi

echo "   โน๏ธ  Keeping tsconfig.tsbuildinfo (helps with incremental builds)"
echo "   โน๏ธ  Keeping test-results/ (JSON/XML reports, videos removed)"
echo ""

# Final status
echo "๐ PRE-PUSH SUMMARY:"
echo "   โ ESLint auto-fix completed"
echo "   โ ESLint check passed"
echo "   โ TypeScript type checking passed"
echo "   โ Build validation passed"
echo "   โ CodeQL security analysis passed"
echo "   โ SonarQube code quality analysis passed"
echo "   โ Secret scanning passed"
echo "   โ Build files cleaned"
echo "   โ Ready for push"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ PRE-PUSH CHECKS COMPLETED SUCCESSFULLY!"
echo "๐ READY TO PUSH TO REMOTE REPOSITORY!"
echo ""
echo "๐ก All checks run locally - CI/CD pipeline will be faster!"
echo "๐ก GitHub Actions will only verify (no duplicate work)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
