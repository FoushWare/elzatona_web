#!/usr/bin/env bash
###############################################################################
# Git Pre-Push Hook
# - Code quality gate
# - Secret scanning
# - Execution time per check
###############################################################################

set -o pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Colors
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Metadata
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
START_TS="$(date +"%Y-%m-%d %H:%M:%S")"
RUN_ID="$(date +%Y%m%d_%H%M%S)"
LOG_FILE=".code-quality-check.$RUN_ID.log"

FAILED_CHECKS=()
PASSED_CHECKS=()
CHECK_DURATIONS=()

###############################################################################
# Banner
###############################################################################
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ” Git Pre-Push Quality & Security Gate"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“… Started : $START_TS"
echo "ğŸ†” Run ID  : $RUN_ID"
echo "ğŸ“„ Log    : $LOG_FILE"
echo ""

###############################################################################
# Environment validation
###############################################################################
echo -e "${BLUE}ğŸ” Validating environment${NC}"

for cmd in node npm npx git; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo -e "${RED}âŒ Missing required command: $cmd${NC}"
    exit 1
  fi
done

if [ ! -f package.json ]; then
  echo -e "${RED}âŒ package.json not found${NC}"
  exit 1
fi

echo -e "${GREEN}âœ… Environment OK${NC}"
echo ""

###############################################################################
# Load env vars
###############################################################################
if [ -f .env.local ]; then
  echo -e "${BLUE}ğŸ“¦ Loading .env.local${NC}"
  set -a
  source .env.local
  set +a
fi

###############################################################################
# Utility: timed check runner
###############################################################################
run_check() {
  local name="$1"
  local command="$2"
  local fix_hint="$3"

  local start end duration exit_code

  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‹ $name"
  echo "ğŸ§ª $command"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  start=$(date +%s)

  {
    echo "[$(date +"%H:%M:%S")] START $name"
    bash -c "$command"
    exit_code=$?
    echo "[$(date +"%H:%M:%S")] END $name (exit=$exit_code)"
    return $exit_code
  } >>"$LOG_FILE" 2>&1

  exit_code=$?
  end=$(date +%s)
  duration=$((end - start))
  CHECK_DURATIONS+=("$name: ${duration}s")

  if [ $exit_code -eq 0 ]; then
    echo -e "${GREEN}âœ… $name passed (${duration}s)${NC}"
    PASSED_CHECKS+=("$name")
  else
    echo -e "${RED}âŒ $name failed (${duration}s)${NC}"
    FAILED_CHECKS+=("$name")

    [ -n "$fix_hint" ] && echo -e "${YELLOW}ğŸ’¡ $fix_hint${NC}"

    echo -e "${BLUE}ğŸ“„ Log tail (last 40 lines):${NC}"
    tail -n 40 "$LOG_FILE" | sed 's/^/   /'
    echo -e "${RED}ğŸ” Check '$name' failed with exit code $exit_code${NC}"
    echo -e "${CYAN}ğŸ“„ Full log: $LOG_FILE${NC}"
  fi

  return $exit_code
}

###############################################################################
# STEP 0: Secret Scanning (FAIL FAST)
###############################################################################
echo "STEP 0: Secret Scanning"

if command -v gitleaks >/dev/null 2>&1; then
  # Create temporary directory with staged files only
  STAGED_DIR=$(mktemp -d)
  git diff --cached --name-only --diff-filter=AM | while read file; do
    if [ -f "$file" ]; then
      mkdir -p "$STAGED_DIR/$(dirname "$file")"
      cp "$file" "$STAGED_DIR/$file"
    fi
  done
  
  run_check \
    "Secret Scan (Gitleaks)" \
    "cd '$STAGED_DIR' && gitleaks detect --redact --exit-code 1 --no-git --source . && cd -" \
    "Remove secrets and rotate compromised credentials"
  
  # Clean up temporary directory
  rm -rf "$STAGED_DIR"
else
  echo -e "${YELLOW}âš ï¸  Gitleaks not installed â€” skipping secret scan${NC}"
  echo -e "${YELLOW}ğŸ’¡ Install: https://github.com/gitleaks/gitleaks${NC}"
fi

###############################################################################
# STEP 1: Prettier
###############################################################################
echo ""
echo "STEP 1: Formatting"
run_check \
  "Prettier" \
  "NODE_OPTIONS=\"--max-old-space-size=512\" npx prettier --check . --ignore-path .prettierignore | tee /tmp/prettier-check.log" \
  "npm run format"

# Print failed Prettier files directly to terminal for clarity
if grep -q 'FAILED' /tmp/prettier-check.log; then
  echo -e "${RED}âŒ Prettier failed for the following files:${NC}"
  grep 'FAILED' /tmp/prettier-check.log | sed 's/^/   /'
fi

###############################################################################
# STEP 2: ESLint
###############################################################################
echo ""
echo "STEP 2: Linting"
run_check \
  "ESLint" \
  "NODE_OPTIONS=\"--max-old-space-size=512\" npm run lint | tee /tmp/eslint-check.log" \
  "npm run lint:fix"

# Print failed ESLint files/errors directly to terminal for clarity
if grep -E 'error|problem|âœ–' /tmp/eslint-check.log; then
  echo -e "${RED}âŒ ESLint failed with the following errors:${NC}"
  grep -E 'error|problem|âœ–' /tmp/eslint-check.log | sed 's/^/   /'
fi

###############################################################################
# STEP 3: TypeScript
###############################################################################
echo ""
echo "STEP 3: Type Checking"
run_check \
  "TypeScript" \
  "NODE_OPTIONS=\"--max-old-space-size=1024\" npm run type-check" \
  "Fix TypeScript errors"

###############################################################################
# STEP 4: Build
###############################################################################
echo ""
if [ "$SKIP_BUILD_CHECK" = "true" ]; then
  echo -e "${YELLOW}â­ï¸  Build skipped${NC}"
else
  echo "STEP 4: Build"
  run_check \
    "Build" \
    "NODE_OPTIONS=\"--max-old-space-size=1024\" npm run build" \
    "Fix build errors"
fi

###############################################################################
# STEP 5: SonarQube
###############################################################################
echo ""
if [ -n "$SONAR_TOKEN" ] && [ "$SKIP_SONAR_CHECK" != "true" ]; then
  echo "STEP 5: SonarQube"
  run_check \
    "SonarQube" \
    "NODE_OPTIONS=\"--max-old-space-size=768\" SONAR_MEMORY_LIMIT=768 npm run sonar:quick" \
    "Fix SonarQube issues"
else
  echo -e "${YELLOW}â­ï¸  SonarQube skipped${NC}"
fi

###############################################################################
# Summary
###############################################################################
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if [ ${#FAILED_CHECKS[@]} -eq 0 ]; then
  echo -e "${GREEN}âœ… All checks passed${NC}"
else
  echo -e "${RED}âŒ Push blocked${NC}"
fi

echo ""
echo "â±ï¸  Execution time per check:"
for t in "${CHECK_DURATIONS[@]}"; do
  echo "   â€¢ $t"
done

echo ""
echo "ğŸ“„ Log file: $LOG_FILE"


if [ ${#FAILED_CHECKS[@]} -ne 0 ]; then
  echo ""
  echo -e "${YELLOW}âš ï¸  Fix issues or bypass with:${NC}"
  echo "   git push --no-verify"
  echo -e "${RED}â”â”â” ERRORS & WARNINGS â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  # Print all error and warning lines from the log file
  grep -E "\\[error]|\\[warn]|failed|SyntaxError|Declaration or statement expected|expected|âŒ" "$LOG_FILE" | sed 's/^/   /'
  echo -e "${BLUE}â”â”â” LOG TAIL (last 40 lines) â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  tail -n 40 "$LOG_FILE" | sed 's/^/   /'
  echo -e "${CYAN}ğŸ“„ Full log: $LOG_FILE${NC}"
  exit 1
fi

echo ""
echo -e "${GREEN}ğŸš€ Safe to push${NC}"
exit 0
