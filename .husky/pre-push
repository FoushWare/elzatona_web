#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ PRE-PUSH HOOK (Comprehensive Checks)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "๐ Current branch: $current_branch"
echo ""

# Only run comprehensive checks on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "๐ Running pre-push checks on development branch..."
  echo ""
  
  # Step 1: Auto-fix linting issues
  echo "๐ STEP 1: Running ESLint with auto-fix..."
  echo "   ๐ Executing: npm run lint:fix"
  echo "   โณ This may take a moment..."
  echo ""
  
  npm run lint:fix
  LINT_FIX_EXIT_CODE=$?
  
  echo ""
  if [ $LINT_FIX_EXIT_CODE -ne 0 ]; then
    echo "   โ๏ธ  ESLint auto-fix completed with warnings (exit code: $LINT_FIX_EXIT_CODE)"
    echo "   ๐ก Some issues may require manual fixes"
  else
    echo "   โ ESLint auto-fix completed successfully!"
  fi
  echo ""
  
  # Step 2: Run linting check (after auto-fix)
  echo "๐ STEP 2: Running ESLint check (after auto-fix)..."
  echo "   ๐ Executing: npm run lint"
  echo "   โณ Checking for remaining linting issues..."
  echo ""
  
  npm run lint || true  # Allow warnings to pass
  LINT_EXIT_CODE=$?
  
  echo ""
  if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "   โ๏ธ  ESLint found remaining issues (exit code: $LINT_EXIT_CODE)"
    echo "   ๐ก Please review and fix the remaining linting issues"
    echo "   ๐ง You can run 'npm run lint:fix' to auto-fix more issues"
    echo "   ๐ Allowing push to proceed (warnings only)"
  else
    echo "   โ ESLint check passed successfully!"
  fi
  echo ""
  
  # Step 3: TypeScript type checking (memory-optimized for 8GB RAM)
  echo "๐ STEP 3: Running TypeScript type checking..."
  echo "   ๐ Executing: npm run type-check"
  echo "   โณ Checking for TypeScript errors..."
  echo "   ๐พ Memory-optimized: Single-threaded mode"
  echo ""
  
  # Limit memory usage for TypeScript (8GB RAM system)
  NODE_OPTIONS="--max-old-space-size=2048" npm run type-check
  TS_EXIT_CODE=$?
  
  echo ""
  if [ $TS_EXIT_CODE -ne 0 ]; then
    echo "   โ TypeScript type checking failed with exit code: $TS_EXIT_CODE"
    echo "   ๐ก Please fix TypeScript errors before pushing"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ PRE-PUSH HOOK FAILED - TYPESCRIPT ERRORS DETECTED!"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    exit 1
  else
    echo "   โ TypeScript type checking passed successfully!"
  fi
  echo ""
  
  # Step 4: Build check (includes TypeScript compilation) - ONLY local check (no duplication)
  echo "๐๏ธ  STEP 4: Running build validation..."
  echo "   ๐ฆ Executing: npm run build"
  echo "   โณ This may take a moment..."
  echo "   ๐ก This is the ONLY build check (removed from GitHub Actions to avoid duplication)"
  echo "   ๐พ Memory-optimized: Single-threaded, limited memory usage"
  echo ""
  
  # Run build with memory optimization (8GB RAM system)
  # Limit Node.js memory and disable parallel processing
  NODE_OPTIONS="--max-old-space-size=2048" NEXT_TELEMETRY_DISABLED=1 npm run build
  BUILD_EXIT_CODE=$?
  
  echo ""
  if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "   โ Build failed with exit code: $BUILD_EXIT_CODE"
    echo "   ๐ก Please fix build issues before pushing"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ PRE-PUSH HOOK FAILED - BUILD ERRORS DETECTED!"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    exit 1
  else
    echo "   โ Build completed successfully!"
  fi
  echo ""
  
  # Step 5: Secret scanning on changed files (CRITICAL - prevents secrets from reaching GitHub)
  echo "๐ STEP 5: Running secret scanning on changed files..."
  echo "   ๐ This is the ONLY local secret scan (pre-commit scan removed to avoid duplication)"
  echo "   ๐ GitHub will also scan automatically after push as backup"
  echo ""
  if [ -f "scripts/pre-push-secret-scan.sh" ]; then
    bash scripts/pre-push-secret-scan.sh "$@"
    SECRET_SCAN_EXIT_CODE=$?
    
    if [ $SECRET_SCAN_EXIT_CODE -ne 0 ]; then
      echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      echo "โ PRE-PUSH HOOK FAILED - SECRETS DETECTED!"
      echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      echo ""
      exit 1
    fi
  else
    echo "   โ๏ธ  Secret scanning script not found (scripts/pre-push-secret-scan.sh)"
    echo "   ๐ก Secret scanning is recommended for security"
  fi
  echo ""
  
  # Step 6: Add auto-fixed files to staging
  echo "๐ฆ STEP 6: Adding auto-fixed files to staging..."
  git add .
  echo "   โ Auto-fixed files added to staging"
  echo ""
  
  # Step 7: Clean up build files after successful build
  echo "๐งน STEP 7: Cleaning build files..."
  
  echo "   ๐๏ธ  Removing .next directory..."
  if [ -d ".next" ]; then
    rm -rf .next
    echo "   โ .next directory removed"
  else
    echo "   โน๏ธ  .next directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing build directory..."
  if [ -d "build" ]; then
    rm -rf build
    echo "   โ build directory removed"
  else
    echo "   โน๏ธ  build directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing storybook-static directory..."
  if [ -d "storybook-static" ]; then
    rm -rf storybook-static
    echo "   โ storybook-static directory removed"
  else
    echo "   โน๏ธ  storybook-static directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing test-results directory..."
  if [ -d "test-results" ]; then
    rm -rf test-results
    echo "   โ test-results directory removed"
  else
    echo "   โน๏ธ  test-results directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing coverage directory..."
  if [ -d "coverage" ]; then
    rm -rf coverage
    echo "   โ coverage directory removed"
  else
    echo "   โน๏ธ  coverage directory not found (already clean)"
  fi
  
  echo "   โน๏ธ  Keeping tsconfig.tsbuildinfo (helps with incremental builds)"
  echo ""
  
  # Final status
  echo "๐ PRE-PUSH SUMMARY:"
  echo "   โ ESLint auto-fix completed"
  echo "   โ ESLint check passed"
  echo "   โ TypeScript type checking passed"
  echo "   โ Build validation passed"
  echo "   โ Secret scanning passed"
  echo "   โ Build files cleaned"
  echo "   โ Ready for push"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โ PRE-PUSH CHECKS COMPLETED SUCCESSFULLY!"
  echo "๐ READY TO PUSH TO REMOTE REPOSITORY!"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
else
  echo "โน๏ธ  Branch '$current_branch' is not a development branch"
  echo "๐ก Pre-push checks only run on: main, develop, release/v1.0.0-main-website"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โน๏ธ  PRE-PUSH HOOK SKIPPED (Non-development branch)"
  echo "๐ READY TO PUSH!"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
fi
