#!/usr/bin/env sh

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งน POST-COMMIT HOOK STARTING..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "๐ Current branch: $current_branch"
echo ""

# Only run cleanup on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "๐ Running cleanup on development branch..."
  echo ""
  
  # Step 1: Remove build directories and files
  echo "๐ STEP 1: Cleaning build directories and files..."
  
  echo "   ๐๏ธ  Removing build directory..."
  if [ -d "build" ]; then
    rm -rf build
    echo "   โ build directory removed"
  else
    echo "   โน๏ธ  build directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing storybook-static directory..."
  if [ -d "storybook-static" ]; then
    rm -rf storybook-static
    echo "   โ storybook-static directory removed"
  else
    echo "   โน๏ธ  storybook-static directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing .next directory..."
  if [ -d ".next" ]; then
    rm -rf .next
    echo "   โ .next directory removed"
  else
    echo "   โน๏ธ  .next directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing tsconfig.tsbuildinfo..."
  if [ -f "tsconfig.tsbuildinfo" ]; then
    rm -f tsconfig.tsbuildinfo
    echo "   โ tsconfig.tsbuildinfo removed"
  else
    echo "   โน๏ธ  tsconfig.tsbuildinfo not found (already clean)"
  fi
  echo ""
  
  # Step 2: Remove build artifacts (but keep Next.js cache)
  echo "๐ STEP 2: Cleaning build artifacts..."
  echo "   โน๏ธ  Keeping TypeScript build info (helps with incremental builds)"
  
  echo "   ๐๏ธ  Removing test results..."
  if [ -d "test-results" ]; then
    rm -rf test-results
    echo "   โ test-results directory removed"
  else
    echo "   โน๏ธ  test-results directory not found (already clean)"
  fi
  
  echo "   ๐๏ธ  Removing coverage reports..."
  if [ -d "coverage" ]; then
    rm -rf coverage
    echo "   โ coverage directory removed"
  else
    echo "   โน๏ธ  coverage directory not found (already clean)"
  fi
  echo ""
  
  # Step 3: Kill running servers
  echo "๐ STEP 3: Stopping old development servers..."
  echo "   ๐ Checking for running npm dev processes..."
  
  # Check if any dev servers are running
  if pgrep -f "npm run dev" > /dev/null; then
    echo "   ๐ Found running dev server, stopping..."
    pkill -f "npm run dev" || true
    sleep 1
    echo "   โ Dev server stopped"
  else
    echo "   โน๏ธ  No dev server running"
  fi
  
  if pgrep -f "npm run start" > /dev/null; then
    echo "   ๐ Found running start server, stopping..."
    pkill -f "npm run start" || true
    sleep 1
    echo "   โ Start server stopped"
  else
    echo "   โน๏ธ  No start server running"
  fi
  
  if pgrep -f "next-server" > /dev/null; then
    echo "   ๐ Found running next-server, stopping..."
    pkill -f "next-server" || true
    sleep 1
    echo "   โ Next server stopped"
  else
    echo "   โน๏ธ  No next-server running"
  fi
  echo ""
  
  # Step 4: Start development server
  echo "๐ STEP 4: Starting development server..."
  
  echo "   ๐ Starting fresh development server..."
  nohup npm run dev > dev.log 2>&1 &
  SERVER_PID=$!
  echo "   ๐ Server PID: $SERVER_PID"
  echo "   โณ Server starting in background..."
  echo "   ๐ก Check dev.log for server output"
  echo "   ๐ Server will be available at http://localhost:3000 when ready"
  echo "   โ๏ธ  Note: Server may take 10-30 seconds to fully start"
  echo ""
  
  # Step 5: Push to remote repository
  echo "๐ STEP 5: Pushing changes to remote repository..."
  echo "   ๐ค Pushing branch '$current_branch' to origin..."
  
  # Push to remote with detailed output
  if git push origin "$current_branch" --verbose; then
    echo "   โ Successfully pushed to remote repository"
    echo "   ๐ Changes are now available on GitHub"
  else
    echo "   โ Failed to push to remote repository"
    echo "   ๐ก You may need to push manually: git push origin $current_branch"
  fi
  echo ""
  
  # Step 6: Final status
  echo "๐ COMPLETE SUMMARY:"
  echo "   โ Build directories cleaned"
  echo "   โ Build artifacts removed"
  echo "   โ Old servers stopped"
  echo "   ๐ New server starting in background"
  echo "   โ Changes pushed to remote"
  echo "   ๐ Logs available in dev.log"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โ POST-COMMIT WORKFLOW COMPLETED SUCCESSFULLY!"
  echo "๐ Your changes are now live on GitHub!"
  echo "๐ Server will be ready shortly at http://localhost:3000"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
else
  echo "โน๏ธ  Branch '$current_branch' is not a development branch"
  echo "๐ก Build cleanup only runs on: main, develop, release/v1.0.0-main-website"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "โน๏ธ  POST-COMMIT HOOK SKIPPED (Non-development branch)"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
fi
