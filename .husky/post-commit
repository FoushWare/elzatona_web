#!/usr/bin/env sh

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ§¹ POST-COMMIT HOOK STARTING..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "ğŸ“ Current branch: $current_branch"
echo ""

# Only run cleanup on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "ğŸ”„ Running cleanup on development branch..."
  echo ""
  
  # Step 1: Remove build directories and files
  echo "ğŸ“ STEP 1: Cleaning build directories and files..."
  
  echo "   ğŸ—‘ï¸  Removing build directory..."
  if [ -d "build" ]; then
    rm -rf build
    echo "   âœ… build directory removed"
  else
    echo "   â„¹ï¸  build directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing storybook-static directory..."
  if [ -d "storybook-static" ]; then
    rm -rf storybook-static
    echo "   âœ… storybook-static directory removed"
  else
    echo "   â„¹ï¸  storybook-static directory not found (already clean)"
  fi
  
  echo "   â„¹ï¸  Keeping .next directory (required for Next.js development)"
  
  echo "   â„¹ï¸  Keeping tsconfig.tsbuildinfo (helps with incremental builds)"
  echo ""
  
  # Step 2: Remove build artifacts (but keep Next.js cache)
  echo "ğŸ“„ STEP 2: Cleaning build artifacts..."
  echo "   â„¹ï¸  Keeping TypeScript build info (helps with incremental builds)"
  
  echo "   ğŸ—‘ï¸  Removing test results..."
  if [ -d "test-results" ]; then
    rm -rf test-results
    echo "   âœ… test-results directory removed"
  else
    echo "   â„¹ï¸  test-results directory not found (already clean)"
  fi
  
  echo "   ğŸ—‘ï¸  Removing coverage reports..."
  if [ -d "coverage" ]; then
    rm -rf coverage
    echo "   âœ… coverage directory removed"
  else
    echo "   â„¹ï¸  coverage directory not found (already clean)"
  fi
  echo ""
  
  # Step 3: Kill running servers
  echo "ğŸ’€ STEP 3: Stopping old development servers..."
  echo "   ğŸ” Checking for running npm dev processes..."
  
  # Check if any dev servers are running
  if pgrep -f "npm run dev" > /dev/null; then
    echo "   ğŸ›‘ Found running dev server, stopping..."
    pkill -f "npm run dev" || true
    sleep 1
    echo "   âœ… Dev server stopped"
  else
    echo "   â„¹ï¸  No dev server running"
  fi
  
  if pgrep -f "npm run start" > /dev/null; then
    echo "   ğŸ›‘ Found running start server, stopping..."
    pkill -f "npm run start" || true
    sleep 1
    echo "   âœ… Start server stopped"
  else
    echo "   â„¹ï¸  No start server running"
  fi
  
  if pgrep -f "next-server" > /dev/null; then
    echo "   ğŸ›‘ Found running next-server, stopping..."
    pkill -f "next-server" || true
    sleep 1
    echo "   âœ… Next server stopped"
  else
    echo "   â„¹ï¸  No next-server running"
  fi
  echo ""
  
# Step 4: Start development server in separate terminal
echo "ğŸš€ STEP 4: Starting development server in separate terminal..."

# Check if we're on macOS (Darwin) or Linux
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - use osascript to open new terminal
    echo "   ğŸ–¥ï¸  Opening new terminal window for development server..."
    osascript -e 'tell application "Terminal" to do script "cd \"'$(pwd)'\" && npm run dev"'
    echo "   âœ… Development server started in new Terminal window"
elif command -v gnome-terminal &> /dev/null; then
    # Linux with gnome-terminal
    echo "   ğŸ–¥ï¸  Opening new terminal window for development server..."
    gnome-terminal -- bash -c "cd '$(pwd)' && npm run dev; exec bash"
    echo "   âœ… Development server started in new terminal window"
elif command -v xterm &> /dev/null; then
    # Linux with xterm
    echo "   ğŸ–¥ï¸  Opening new terminal window for development server..."
    xterm -e "cd '$(pwd)' && npm run dev" &
    echo "   âœ… Development server started in new terminal window"
else
    # Fallback to background process
    echo "   ğŸ“ Starting development server in background..."
    nohup npm run dev > dev.log 2>&1 &
    SERVER_PID=$!
    echo "   ğŸ“‹ Server PID: $SERVER_PID"
    echo "   â³ Server starting in background..."
    echo "   ğŸ’¡ Check dev.log for server output"
fi

echo "   ğŸŒ Server will be available at http://localhost:3000 when ready"
echo "   âš ï¸  Note: Server may take 10-30 seconds to fully start"
echo ""
  
  # Step 5: Skip auto-push (manual push recommended)
  echo "ğŸš€ STEP 5: Push to remote repository (manual)..."
  echo "   â­ï¸  Skipping auto-push to avoid blocking"
  echo "   ğŸ’¡ Run 'git push origin $current_branch' when ready"
  echo "   ğŸŒ This allows you to review changes before pushing"
  echo ""
  
  # Step 6: Final status
  echo "ğŸ“Š COMPLETE SUMMARY:"
  echo "   âœ… Build directories cleaned"
  echo "   âœ… Build artifacts removed"
  echo "   âœ… Old servers stopped"
  echo "   ğŸ–¥ï¸  New server started in separate terminal"
  echo "   â­ï¸  Manual push recommended"
  echo "   ğŸ“ Check new terminal for server output"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âœ… POST-COMMIT WORKFLOW COMPLETED SUCCESSFULLY!"
  echo "ğŸš€ Development server started in new terminal window"
  echo "ğŸŒ Server will be ready shortly at http://localhost:3000"
  echo "ğŸ’¡ Push changes manually when ready: git push origin $current_branch"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
else
  echo "â„¹ï¸  Branch '$current_branch' is not a development branch"
  echo "ğŸ’¡ Build cleanup only runs on: main, develop, release/v1.0.0-main-website"
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "â„¹ï¸  POST-COMMIT HOOK SKIPPED (Non-development branch)"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
fi
