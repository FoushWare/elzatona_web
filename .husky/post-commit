#!/usr/bin/env sh

echo "ğŸ§¹ Post-commit cleanup starting..."

# Get the current branch name
current_branch=$(git branch --show-current)

# Only run cleanup on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "ğŸ”„ On main development branch, cleaning up build files..."
  
  # Remove build directories
  echo "ğŸ—‘ï¸  Removing .next directory..."
  rm -rf .next
  
  echo "ğŸ—‘ï¸  Removing build directory..."
  rm -rf build
  
  echo "ğŸ—‘ï¸  Removing storybook-static directory..."
  rm -rf storybook-static
  
  # Remove other build artifacts
  echo "ğŸ—‘ï¸  Removing TypeScript build info..."
  rm -f tsconfig.tsbuildinfo
  
  echo "ğŸ—‘ï¸  Removing test results..."
  rm -rf test-results
  
  echo "ğŸ—‘ï¸  Removing coverage reports..."
  rm -rf coverage
  
  # Kill any running development servers
  echo "ğŸ’€ Killing old development servers..."
  pkill -f "npm run dev" || true
  pkill -f "npm run start" || true
  pkill -f "next-server" || true
  
  # Restart development server
  echo "ğŸš€ Restarting development server..."
  nohup npm run dev > dev.log 2>&1 &
  
  echo "âœ… Post-commit cleanup completed!"
  echo "ğŸ“ Development server restarted and running in background"
  echo "ğŸ“‹ Check dev.log for server output"
else
  echo "â„¹ï¸  On branch '$current_branch', skipping build cleanup"
  echo "ğŸ’¡ Build cleanup only runs on main development branches"
fi
