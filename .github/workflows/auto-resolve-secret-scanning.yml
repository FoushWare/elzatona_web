name: Auto-Resolve Secret Scanning Alerts

on:
  workflow_dispatch:
    inputs:
      resolution:
        description: 'Resolution type (revoked, false_positive, used_in_tests, wont_fix)'
        required: true
        default: 'revoked'
        type: choice
        options:
          - revoked
          - false_positive
          - used_in_tests
          - wont_fix
      comment:
        description: 'Optional comment for resolution'
        required: false
        type: string
      secret_type:
        description: 'Filter by secret type (leave empty for all)'
        required: false
        type: string
  schedule:
    # Run daily at 2 AM UTC to auto-resolve alerts after rotation
    - cron: '0 2 * * *'
  repository_dispatch:
    types: [resolve-secret-alerts]

permissions:
  security-events: write
  contents: read

jobs:
  resolve-alerts:
    name: Resolve Secret Scanning Alerts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve Secret Scanning Alerts
        env:
          RESOLUTION: ${{ inputs.resolution || 'revoked' }}
          COMMENT: ${{ inputs.comment || 'Automatically resolved via workflow' }}
          SECRET_TYPE: ${{ inputs.secret_type || '' }}
        run: |
          echo "üîç Fetching open secret scanning alerts..."
          
          # Get all open alerts
          ALERTS=$(gh api repos/${{ github.repository }}/secret-scanning/alerts \
            --paginate \
            --jq '[.[] | select(.state == "open")]')
          
          TOTAL=$(echo "$ALERTS" | jq 'length')
          echo "üìä Found $TOTAL open alerts"
          
          if [ "$TOTAL" -eq 0 ]; then
            echo "‚úÖ No open alerts to resolve"
            exit 0
          fi
          
          # Filter by secret type if specified
          if [ -n "$SECRET_TYPE" ]; then
            ALERTS=$(echo "$ALERTS" | jq "[.[] | select(.secret_type == \"$SECRET_TYPE\")]")
            FILTERED=$(echo "$ALERTS" | jq 'length')
            echo "üîç Filtered to $FILTERED alerts of type: $SECRET_TYPE"
          fi
          
          RESOLVED=0
          FAILED=0
          
          # Resolve each alert
          echo "$ALERTS" | jq -c '.[]' | while read -r alert; do
            ALERT_NUMBER=$(echo "$alert" | jq -r '.number')
            SECRET_TYPE_NAME=$(echo "$alert" | jq -r '.secret_type')
            PATH=$(echo "$alert" | jq -r '.first_location_detected.path')
            
            echo ""
            echo "üîß Resolving alert #$ALERT_NUMBER ($SECRET_TYPE_NAME in $PATH)..."
            
            # Prepare resolution payload
            PAYLOAD=$(jq -n \
              --arg resolution "$RESOLUTION" \
              --arg comment "$COMMENT" \
              '{
                state: "resolved",
                resolution: $resolution,
                resolution_comment: $comment
              }')
            
            # Resolve the alert
            if gh api \
              repos/${{ github.repository }}/secret-scanning/alerts/$ALERT_NUMBER \
              --method PATCH \
              --input - <<< "$PAYLOAD" 2>/dev/null; then
              echo "‚úÖ Alert #$ALERT_NUMBER resolved"
              RESOLVED=$((RESOLVED + 1))
            else
              echo "‚ùå Failed to resolve alert #$ALERT_NUMBER"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "üìä Summary:"
          echo "   ‚úÖ Resolved: $RESOLVED"
          echo "   ‚ùå Failed: $FAILED"
          
          if [ "$FAILED" -gt 0 ]; then
            echo "‚ö†Ô∏è  Some alerts failed to resolve. Check permissions and alert status."
            exit 1
          fi

      - name: Create Summary Comment
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: alerts } = await github.rest.secretScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const summary = `## Secret Scanning Resolution Summary
            
            **Resolution Type:** ${{ inputs.resolution || 'revoked' }}
            **Remaining Open Alerts:** ${alerts.length}
            
            ${alerts.length === 0 
              ? '‚úÖ All alerts have been resolved!' 
              : `‚ö†Ô∏è  ${alerts.length} alerts still open. Run the workflow again or resolve manually.`}
            
            View all alerts: https://github.com/${{ github.repository }}/security/secret-scanning
            `;
            
            console.log(summary);

