{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/libs/shared-contexts/src/lib/AuthContext.tsx"],"sourcesContent":["'use client';\n\nimport {\n  createContext,\n  useContext,\n  useState,\n  useEffect,\n  ReactNode,\n} from 'react';\n// import { UserAuthService } from '@/lib/user-auth';\n// Note: syncAllProgressOnLogin is website-specific and should be imported where needed\n// import { syncAllProgressOnLogin } from '@/lib/sync-progress-on-login';\nimport { Loader2 } from 'lucide-react';\n\ninterface User {\n  id: string;\n  name: string;\n  email: string;\n  avatar?: string;\n  role: 'user' | 'premium_user' | 'admin' | 'super_admin';\n  preferences?: {\n    theme: 'light' | 'dark' | 'system';\n    notifications: boolean;\n    emailUpdates: boolean;\n  };\n  progress?: {\n    completedQuestions: string[];\n    completedPaths: string[];\n    streak: number;\n    totalTimeSpent: number;\n  };\n}\n\ninterface AuthContextType {\n  user: User | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  isLoggingOut: boolean;\n  login: (email: string, password: string) => Promise<boolean>;\n  signup: (name: string, email: string, password: string) => Promise<boolean>;\n  logout: () => Promise<void>;\n  updateUser: (userData: Partial<User>) => void;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n\ninterface AuthProviderProps {\n  children: ReactNode;\n}\n\nexport function AuthProvider({ children }: AuthProviderProps) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isLoggingOut, setIsLoggingOut] = useState(false);\n\n  // Check if user is already logged in on mount\n  useEffect(() => {\n    const checkAuthStatus = () => {\n      try {\n        const storedUser = localStorage.getItem('frontend-koddev-user');\n        if (storedUser) {\n          const userData = JSON.parse(storedUser);\n          setUser(userData);\n        }\n      } catch (error) {\n        console.error('Error checking auth status:', error);\n        localStorage.removeItem('frontend-koddev-user');\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    checkAuthStatus();\n  }, []);\n\n  const login = async (email: string, password: string): Promise<boolean> => {\n    try {\n      setIsLoading(true);\n\n      // Call the authentication API\n      const response = await fetch('/api/auth', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ email, password }),\n      });\n\n      const data = await response.json();\n\n      if (data.success && data.user) {\n        // Convert session to user format\n        const userData: User = {\n          id: data.user.id,\n          name: data.user.name,\n          email: data.user.email,\n          role: data.user.role,\n        };\n\n        setUser(userData);\n        localStorage.setItem('frontend-koddev-user', JSON.stringify(userData));\n        localStorage.setItem('auth-token', data.user.token);\n\n        // Sync all localStorage progress to database after successful login\n        // Note: This is website-specific functionality and should be handled in the website app\n        // The syncAllProgressOnLogin function should be imported and called in the website app's login flow\n        // try {\n        //   console.log('üîÑ Syncing progress to database after login...');\n        //   const syncResult = await syncAllProgressOnLogin(\n        //     data.user.token,\n        //     data.user.id\n        //   );\n        //   if (syncResult.success) {\n        //     console.log('‚úÖ Progress synced successfully after login');\n        //   } else {\n        //     console.warn('‚ö†Ô∏è Some progress failed to sync:', {\n        //       guided: syncResult.guided.errors,\n        //       freeStyle: syncResult.freeStyle.error,\n        //     });\n        //   }\n        // } catch (syncError) {\n        //   // Don't block login if sync fails\n        //   console.error(\n        //     '‚ùå Error syncing progress on login (non-blocking):',\n        //     syncError\n        //   );\n        // }\n\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error('Login error:', error);\n      return false;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const signup = async (\n    name: string,\n    email: string,\n    password: string\n  ): Promise<boolean> => {\n    try {\n      setIsLoading(true);\n\n      // Call the registration API\n      const response = await fetch('/api/auth', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ name, email, password }),\n      });\n\n      const data = await response.json();\n\n      if (data.success) {\n        // After successful registration, automatically log in\n        return await login(email, password);\n      }\n\n      return false;\n    } catch (error) {\n      console.error('Signup error:', error);\n      return false;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const logout = async () => {\n    try {\n      setIsLoggingOut(true);\n\n      // Clear user state\n      setUser(null);\n\n      // Clear localStorage\n      localStorage.removeItem('frontend-koddev-user');\n      localStorage.removeItem('auth-token');\n\n      // Clear sessionStorage (including navbar-auth-state)\n      try {\n        sessionStorage.clear();\n      } catch (error) {\n        console.error('Error clearing sessionStorage:', error);\n      }\n\n      // Clear isAuthenticated flags\n      localStorage.removeItem('isAuthenticated');\n\n      // Dispatch auth state change event\n      if (typeof window !== 'undefined') {\n        window.dispatchEvent(new Event('auth-state-changed'));\n      }\n\n      // Small delay to ensure state updates are processed\n      await new Promise(resolve => setTimeout(resolve, 100));\n\n      // Navigate to home page\n      if (typeof window !== 'undefined') {\n        window.location.href = '/';\n      }\n    } catch (error) {\n      console.error('Logout error:', error);\n      // Still navigate even if there's an error\n      if (typeof window !== 'undefined') {\n        window.location.href = '/';\n      }\n    } finally {\n      // This may not execute if navigation happens, but it's good to have\n      setIsLoggingOut(false);\n    }\n  };\n\n  const updateUser = (userData: Partial<User>) => {\n    if (user) {\n      const updatedUser = { ...user, ...userData };\n      setUser(updatedUser);\n      localStorage.setItem('frontend-koddev-user', JSON.stringify(updatedUser));\n    }\n  };\n\n  const value: AuthContextType = {\n    user,\n    isAuthenticated: !!user,\n    isLoading,\n    isLoggingOut,\n    login,\n    signup,\n    logout,\n    updateUser,\n  };\n\n  return (\n    <AuthContext.Provider value={value}>\n      {children}\n      {/* Global logout loading overlay */}\n      {isLoggingOut && (\n        <div className='fixed inset-0 z-[9999] bg-black/50 backdrop-blur-sm flex items-center justify-center'>\n          <div className='bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-2xl flex flex-col items-center space-y-4 min-w-[200px]'>\n            <Loader2 className='w-8 h-8 text-indigo-600 dark:text-indigo-400 animate-spin' />\n            <p className='text-gray-900 dark:text-white font-medium text-center'>\n              Logging out...\n            </p>\n            <p className='text-sm text-gray-500 dark:text-gray-400 text-center'>\n              Redirecting to home\n            </p>\n          </div>\n        </div>\n      )}\n    </AuthContext.Provider>\n  );\n}\n"],"names":["AuthProvider","useAuth","AuthContext","createContext","undefined","context","useContext","Error","children","user","setUser","useState","isLoading","setIsLoading","isLoggingOut","setIsLoggingOut","useEffect","checkAuthStatus","storedUser","localStorage","getItem","userData","JSON","parse","error","console","removeItem","login","email","password","response","fetch","method","headers","body","stringify","data","json","success","id","name","role","setItem","token","signup","logout","sessionStorage","clear","window","dispatchEvent","Event","Promise","resolve","setTimeout","location","href","updateUser","updatedUser","value","isAuthenticated","Provider","div","className","Loader2","p"],"mappings":"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"}