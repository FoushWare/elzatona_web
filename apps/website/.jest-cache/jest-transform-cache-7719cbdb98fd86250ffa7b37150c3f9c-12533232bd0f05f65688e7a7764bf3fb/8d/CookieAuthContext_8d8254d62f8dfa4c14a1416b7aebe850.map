{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/libs/shared-contexts/src/lib/CookieAuthContext.tsx"],"sourcesContent":["'use client';\n\nimport {\n  createContext,\n  useContext,\n  useState,\n  useEffect,\n  ReactNode,\n} from 'react';\n\ninterface CookieUser {\n  id: string;\n  email: string | null;\n  name: string | null;\n  image: string | null;\n}\n\ninterface CookieAuthContextType {\n  user: CookieUser | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  signIn: (provider: 'google' | 'github') => Promise<void>;\n  signOut: () => Promise<void>;\n  refreshAuth: () => Promise<void>;\n}\n\nconst CookieAuthContext = createContext<CookieAuthContextType | undefined>(\n  undefined\n);\n\nexport function useCookieAuth() {\n  const context = useContext(CookieAuthContext);\n  if (context === undefined) {\n    throw new Error('useCookieAuth must be used within a CookieAuthProvider');\n  }\n  return context;\n}\n\ninterface CookieAuthProviderProps {\n  children: ReactNode;\n}\n\nexport function CookieAuthProvider({ children }: CookieAuthProviderProps) {\n  const [user, setUser] = useState<CookieUser | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Initialize auth state from cookies\n  useEffect(() => {\n    const initializeAuth = async () => {\n      try {\n        // Check if user data exists in cookies (immediate, no flash)\n        const userDataCookie = getCookie('user-data');\n\n        if (userDataCookie) {\n          const userData = JSON.parse(userDataCookie);\n          setUser(userData);\n          setIsLoading(false);\n          return; // Exit early to prevent flashing\n        }\n\n        // If no cookie, verify session with server\n        const response = await fetch('/api/auth/session');\n        const sessionData = await response.json();\n\n        if (sessionData.isAuthenticated && sessionData.user) {\n          setUser(sessionData.user);\n        } else {\n          setUser(null);\n        }\n      } catch (error) {\n        console.error('Auth initialization error:', error);\n        setUser(null);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    initializeAuth();\n  }, []);\n\n  const signIn = async (provider: 'google' | 'github') => {\n    try {\n      setIsLoading(true);\n\n      // Redirect to NextAuth sign-in\n      const signInUrl = `/api/auth/signin/${provider}`;\n      window.location.href = signInUrl;\n    } catch (error) {\n      console.error('Sign in error:', error);\n      setIsLoading(false);\n    }\n  };\n\n  const signOut = async () => {\n    try {\n      setIsLoading(true);\n\n      // Clear cookies\n      await fetch('/api/auth/session', {\n        method: 'DELETE',\n      });\n\n      // Clear local state\n      setUser(null);\n\n      // Redirect to NextAuth sign-out\n      window.location.href = '/api/auth/signout';\n    } catch (error) {\n      console.error('Sign out error:', error);\n      setIsLoading(false);\n    }\n  };\n\n  const refreshAuth = async () => {\n    try {\n      const response = await fetch('/api/auth/session');\n      const sessionData = await response.json();\n\n      if (sessionData.isAuthenticated && sessionData.user) {\n        setUser(sessionData.user);\n      } else {\n        setUser(null);\n      }\n    } catch (error) {\n      console.error('Auth refresh error:', error);\n    }\n  };\n\n  const value: CookieAuthContextType = {\n    user,\n    isAuthenticated: !!user,\n    isLoading,\n    signIn,\n    signOut,\n    refreshAuth,\n  };\n\n  return (\n    <CookieAuthContext.Provider value={value}>\n      {children}\n    </CookieAuthContext.Provider>\n  );\n}\n\n// Helper function to get cookie value\nfunction getCookie(name: string): string | null {\n  if (typeof document === 'undefined') return null;\n\n  const value = `; ${document.cookie}`;\n  const parts = value.split(`; ${name}=`);\n  if (parts.length === 2) {\n    return parts.pop()?.split(';').shift() || null;\n  }\n  return null;\n}\n"],"names":["CookieAuthProvider","useCookieAuth","CookieAuthContext","createContext","undefined","context","useContext","Error","children","user","setUser","useState","isLoading","setIsLoading","useEffect","initializeAuth","userDataCookie","getCookie","userData","JSON","parse","response","fetch","sessionData","json","isAuthenticated","error","console","signIn","provider","signInUrl","window","location","href","signOut","method","refreshAuth","value","Provider","name","document","cookie","parts","split","length","pop","shift"],"mappings":"AAAA;;;;;;;;;;;;QA0CgBA;eAAAA;;QAZAC;eAAAA;;;;uBAtBT;AAkBP,MAAMC,kCAAoBC,IAAAA,oBAAa,EACrCC;AAGK,SAASH;IACd,MAAMI,UAAUC,IAAAA,iBAAU,EAACJ;IAC3B,IAAIG,YAAYD,WAAW;QACzB,MAAM,IAAIG,MAAM;IAClB;IACA,OAAOF;AACT;AAMO,SAASL,mBAAmB,EAAEQ,QAAQ,EAA2B;IACtE,MAAM,CAACC,MAAMC,QAAQ,GAAGC,IAAAA,eAAQ,EAAoB;IACpD,MAAM,CAACC,WAAWC,aAAa,GAAGF,IAAAA,eAAQ,EAAC;IAE3C,qCAAqC;IACrCG,IAAAA,gBAAS,EAAC;QACR,MAAMC,iBAAiB;YACrB,IAAI;gBACF,6DAA6D;gBAC7D,MAAMC,iBAAiBC,UAAU;gBAEjC,IAAID,gBAAgB;oBAClB,MAAME,WAAWC,KAAKC,KAAK,CAACJ;oBAC5BN,QAAQQ;oBACRL,aAAa;oBACb,QAAQ,iCAAiC;gBAC3C;gBAEA,2CAA2C;gBAC3C,MAAMQ,WAAW,MAAMC,MAAM;gBAC7B,MAAMC,cAAc,MAAMF,SAASG,IAAI;gBAEvC,IAAID,YAAYE,eAAe,IAAIF,YAAYd,IAAI,EAAE;oBACnDC,QAAQa,YAAYd,IAAI;gBAC1B,OAAO;oBACLC,QAAQ;gBACV;YACF,EAAE,OAAOgB,OAAO;gBACdC,QAAQD,KAAK,CAAC,8BAA8BA;gBAC5ChB,QAAQ;YACV,SAAU;gBACRG,aAAa;YACf;QACF;QAEAE;IACF,GAAG,EAAE;IAEL,MAAMa,SAAS,OAAOC;QACpB,IAAI;YACFhB,aAAa;YAEb,+BAA+B;YAC/B,MAAMiB,YAAY,CAAC,iBAAiB,EAAED,UAAU;YAChDE,OAAOC,QAAQ,CAACC,IAAI,GAAGH;QACzB,EAAE,OAAOJ,OAAO;YACdC,QAAQD,KAAK,CAAC,kBAAkBA;YAChCb,aAAa;QACf;IACF;IAEA,MAAMqB,UAAU;QACd,IAAI;YACFrB,aAAa;YAEb,gBAAgB;YAChB,MAAMS,MAAM,qBAAqB;gBAC/Ba,QAAQ;YACV;YAEA,oBAAoB;YACpBzB,QAAQ;YAER,gCAAgC;YAChCqB,OAAOC,QAAQ,CAACC,IAAI,GAAG;QACzB,EAAE,OAAOP,OAAO;YACdC,QAAQD,KAAK,CAAC,mBAAmBA;YACjCb,aAAa;QACf;IACF;IAEA,MAAMuB,cAAc;QAClB,IAAI;YACF,MAAMf,WAAW,MAAMC,MAAM;YAC7B,MAAMC,cAAc,MAAMF,SAASG,IAAI;YAEvC,IAAID,YAAYE,eAAe,IAAIF,YAAYd,IAAI,EAAE;gBACnDC,QAAQa,YAAYd,IAAI;YAC1B,OAAO;gBACLC,QAAQ;YACV;QACF,EAAE,OAAOgB,OAAO;YACdC,QAAQD,KAAK,CAAC,uBAAuBA;QACvC;IACF;IAEA,MAAMW,QAA+B;QACnC5B;QACAgB,iBAAiB,CAAC,CAAChB;QACnBG;QACAgB;QACAM;QACAE;IACF;IAEA,qBACE,qBAAClC,kBAAkBoC,QAAQ;QAACD,OAAOA;kBAChC7B;;AAGP;AAEA,sCAAsC;AACtC,SAASS,UAAUsB,IAAY;IAC7B,IAAI,OAAOC,aAAa,aAAa,OAAO;IAE5C,MAAMH,QAAQ,CAAC,EAAE,EAAEG,SAASC,MAAM,EAAE;IACpC,MAAMC,QAAQL,MAAMM,KAAK,CAAC,CAAC,EAAE,EAAEJ,KAAK,CAAC,CAAC;IACtC,IAAIG,MAAME,MAAM,KAAK,GAAG;QACtB,OAAOF,MAAMG,GAAG,IAAIF,MAAM,KAAKG,WAAW;IAC5C;IACA,OAAO;AACT"}