{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/tests/admin/admin-auth-integration.test.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/**\n * Admin Authentication Integration Tests\n *\n * End-to-end tests for the complete admin authentication flow:\n * - Login process\n * - Session management\n * - Route protection\n * - Logout functionality\n * - Token validation\n */\n\nimport { NextRequest } from 'next/server';\n// @ts-expect-error - Path alias works at runtime via Jest moduleNameMapper\nimport { POST as authPOST } from '@/app/api/admin/auth/route';\nimport jwt from 'jsonwebtoken';\n\n// Mock NextResponse to ensure json() method works correctly\njest.mock('next/server', () => {\n  const actual = jest.requireActual('next/server');\n  return {\n    ...actual,\n    NextResponse: {\n      ...actual.NextResponse,\n      json: (body: any, init?: any) => {\n        const response = actual.NextResponse.json(body, init);\n        // Ensure _body is set for test compatibility\n        (response as any)._body = JSON.stringify(body);\n        return response;\n      },\n    },\n  };\n});\n\n// Helper to extract JSON from NextResponse\nasync function getResponseData(response: any): Promise<any> {\n  if ((response as any)._body !== undefined) {\n    const body = (response as any)._body;\n    if (typeof body === 'string') {\n      try {\n        return JSON.parse(body);\n      } catch {\n        return {};\n      }\n    }\n    if (body && typeof body === 'object') {\n      return body;\n    }\n  }\n  try {\n    const data = await response.json();\n    if (data && typeof data === 'object' && Object.keys(data).length > 0) {\n      return data;\n    }\n  } catch {\n    // Continue\n  }\n  try {\n    const text = await response.text();\n    if (text) {\n      return JSON.parse(text);\n    }\n  } catch {\n    // Continue\n  }\n  return {};\n}\n\n// Mock Supabase - shared instance for route handler\n// Define inside factory to avoid hoisting issues\njest.mock('@supabase/supabase-js', () => {\n  const mockSupabaseClient = {\n    from: jest.fn(),\n  };\n  return {\n    createClient: jest.fn(() => mockSupabaseClient),\n  };\n});\n\n// Mock bcrypt\njest.mock('bcryptjs', () => ({\n  compare: jest.fn(),\n  hash: jest.fn(),\n}));\n\n// Mock admin.config\njest.mock('@/admin.config', () => ({\n  adminConfig: {\n    security: {\n      saltRounds: 10,\n      sessionTimeout: 24 * 60 * 60 * 1000,\n    },\n    jwt: {\n      secret: 'test-jwt-secret-key-for-testing',\n    },\n  },\n}));\n\ndescribe('Admin Authentication Integration', () => {\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  const bcrypt = require('bcryptjs');\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  const { createClient } = require('@supabase/supabase-js');\n  let mockSupabaseClient: any;\n  let consoleErrorSpy: jest.SpyInstance;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    mockSupabaseClient = createClient();\n    mockSupabaseClient.from.mockClear();\n    process.env.JWT_SECRET = 'test-jwt-secret-key-for-testing';\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key';\n    process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n\n    // Suppress console.error for expected error tests\n    // Use jest.spyOn to properly mock and suppress console.error output\n    consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation(() => {\n      // Suppress console.error output during tests\n    });\n  });\n\n  afterEach(() => {\n    // Restore console.error\n    consoleErrorSpy.mockRestore();\n    delete process.env.JWT_SECRET;\n    delete process.env.NEXT_PUBLIC_SUPABASE_URL;\n    delete process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n    delete process.env.SUPABASE_SERVICE_ROLE_KEY;\n  });\n\n  describe('Complete Login Flow', () => {\n    it('should complete full authentication flow successfully', async () => {\n      const mockAdmin = {\n        id: 'admin_123',\n        email: 'test@example.com',\n        name: 'Test Admin',\n        role: 'super_admin',\n        password_hash: 'hashed_password',\n        is_active: true,\n        created_at: new Date().toISOString(),\n      };\n\n      const mockSingle = Promise.resolve({\n        data: mockAdmin,\n        error: null,\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      });\n\n      bcrypt.compare.mockResolvedValue(true);\n\n      // Step 1: Login request\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'testpassword123',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(200);\n      expect(loginData.success).toBe(true);\n      expect(loginData.admin.token).toBeDefined();\n      expect(loginData.admin.expiresAt).toBeDefined();\n\n      // Step 2: Verify JWT token\n      const token = loginData.admin.token;\n      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as {\n        adminId: string;\n        email: string;\n        role: string;\n        exp: number;\n        iat: number;\n      };\n\n      expect(decoded.adminId).toBe(mockAdmin.id);\n      expect(decoded.email).toBe(mockAdmin.email);\n      expect(decoded.role).toBe(mockAdmin.role);\n      expect(decoded.exp).toBeDefined();\n\n      // Step 3: Verify token expiration is reasonable (24 hours)\n      const expirationTime = decoded.exp * 1000; // Convert to milliseconds\n      const now = Date.now();\n      const twentyFourHours = 24 * 60 * 60 * 1000;\n\n      expect(expirationTime - now).toBeGreaterThan(twentyFourHours - 60000); // Allow 1 minute tolerance\n      expect(expirationTime - now).toBeLessThan(twentyFourHours + 60000);\n    });\n\n    it('should handle authentication failure gracefully', async () => {\n      const mockSingle = Promise.resolve({\n        data: null,\n        error: { message: 'Not found' },\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n      });\n\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'wrongpassword',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(401);\n      expect(loginData.success).toBe(false);\n      expect(loginData.error).toBe('Invalid email or password');\n      expect(loginData.admin).toBeUndefined();\n    });\n  });\n\n  describe('Session Management', () => {\n    it('should create valid session after successful login', async () => {\n      const mockAdmin = {\n        id: 'admin_123',\n        email: 'test@example.com',\n        name: 'Test Admin',\n        role: 'super_admin',\n        password_hash: 'hashed_password',\n        is_active: true,\n        created_at: new Date().toISOString(),\n      };\n\n      const mockSingle = Promise.resolve({\n        data: mockAdmin,\n        error: null,\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      });\n\n      bcrypt.compare.mockResolvedValue(true);\n\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'testpassword123',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      // Verify session data structure\n      expect(loginData.admin).toBeDefined();\n      expect(loginData.admin.email).toBe(mockAdmin.email);\n      expect(loginData.admin.name).toBe(mockAdmin.name);\n      expect(loginData.admin.role).toBe(mockAdmin.role);\n      expect(loginData.admin.token).toBeDefined();\n      expect(loginData.admin.expiresAt).toBeDefined();\n\n      // Verify token can be used for subsequent requests\n      const token = loginData.admin.token;\n      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as {\n        adminId: string;\n        email: string;\n        role: string;\n        exp: number;\n        iat: number;\n      };\n\n      expect(decoded.adminId).toBe(mockAdmin.id);\n      expect(decoded.email).toBe(mockAdmin.email);\n      expect(decoded.role).toBe(mockAdmin.role);\n    });\n\n    it('should handle expired tokens', async () => {\n      // Create an expired token\n      const expiredToken = jwt.sign(\n        {\n          adminId: 'admin_test@example.com',\n          email: 'test@example.com',\n          role: 'super_admin',\n          iat: Math.floor(Date.now() / 1000) - 86400, // 24 hours ago\n          exp: Math.floor(Date.now() / 1000) - 3600, // 1 hour ago\n        },\n        process.env.JWT_SECRET!\n      );\n\n      // Attempt to use expired token\n      expect(() => {\n        jwt.verify(expiredToken, process.env.JWT_SECRET!);\n      }).toThrow('jwt expired');\n    });\n\n    it('should handle invalid tokens', async () => {\n      const invalidToken = 'invalid.jwt.token';\n\n      expect(() => {\n        jwt.verify(invalidToken, process.env.JWT_SECRET!);\n      }).toThrow();\n    });\n  });\n\n  describe('Logout Flow', () => {\n    it('should clear session on logout', async () => {\n      // Logout functionality would be tested with the actual logout endpoint\n      // For now, we'll skip this test as it requires a different endpoint\n      // TODO: Implement logout endpoint test when available\n      expect(true).toBe(true);\n    });\n  });\n\n  describe('Route Protection', () => {\n    it('should protect admin routes without valid token', async () => {\n      // This would typically be tested with middleware or route handlers\n      // For now, we'll test the token validation logic\n\n      const invalidToken = 'invalid.token';\n\n      expect(() => {\n        jwt.verify(invalidToken, process.env.JWT_SECRET!);\n      }).toThrow();\n    });\n\n    it('should allow access with valid token', async () => {\n      const validToken = jwt.sign(\n        {\n          adminId: 'admin_123', // Use ID format consistent with route handler\n          email: 'test@example.com',\n          role: 'super_admin',\n          iat: Math.floor(Date.now() / 1000),\n          exp: Math.floor(Date.now() / 1000) + 86400, // 24 hours from now\n        },\n        process.env.JWT_SECRET!\n      );\n\n      const decoded = jwt.verify(validToken, process.env.JWT_SECRET!) as {\n        adminId: string;\n        email: string;\n        role: string;\n        exp: number;\n        iat: number;\n      };\n\n      expect(decoded.adminId).toBe('admin_123');\n      expect(decoded.email).toBe('test@example.com');\n      expect(decoded.role).toBe('super_admin');\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle database connection errors', async () => {\n      const mockSingle = Promise.reject(\n        new Error('Database connection failed')\n      );\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n      });\n\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'testpassword123',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(500);\n      expect(loginData.success).toBe(false);\n      expect(loginData.error).toBeDefined();\n    });\n\n    it('should handle malformed requests', async () => {\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: 'invalid json',\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(400);\n      expect(loginData.success).toBe(false);\n      expect(loginData.error).toBeDefined();\n    });\n\n    it('should handle missing environment variables', async () => {\n      delete process.env.JWT_SECRET;\n\n      const mockAdmin = {\n        id: 'admin_123',\n        email: 'test@example.com',\n        name: 'Test Admin',\n        role: 'super_admin',\n        password_hash: 'hashed_password',\n        is_active: true,\n        created_at: new Date().toISOString(),\n      };\n\n      const mockSingle = Promise.resolve({\n        data: mockAdmin,\n        error: null,\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      });\n\n      bcrypt.compare.mockResolvedValue(true);\n\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'testpassword123',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(500);\n      expect(loginData.success).toBe(false);\n      expect(loginData.error).toBeDefined();\n    });\n  });\n\n  describe('Security Tests', () => {\n    it('should not expose sensitive information in error messages', async () => {\n      const mockSingle = Promise.reject(\n        new Error('Database connection failed: password=secret123')\n      );\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n      });\n\n      const loginRequest = new NextRequest(\n        'http://localhost:3000/api/admin/auth',\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            email: 'test@example.com',\n            password: 'testpassword123',\n          }),\n        }\n      );\n\n      const loginResponse = await authPOST(loginRequest);\n      const loginData = await getResponseData(loginResponse);\n\n      expect(loginResponse.status).toBe(500);\n      expect(loginData.success).toBe(false);\n      expect(loginData.error).toBeDefined();\n      expect(loginData.error).not.toContain('secret123');\n    });\n\n    it('should rate limit login attempts', async () => {\n      // This test would be implemented if rate limiting is added\n      // Set up mock for failed authentication (wrong password)\n      const mockSingle = Promise.resolve({\n        data: {\n          id: 'admin_123',\n          email: 'test@example.com',\n          name: 'Test Admin',\n          role: 'super_admin',\n          password_hash: 'hashed_password',\n          is_active: true,\n          created_at: new Date().toISOString(),\n        },\n        error: null,\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n      });\n\n      // Mock bcrypt to return false (wrong password)\n      bcrypt.compare.mockResolvedValue(false);\n\n      const requests = Array(10)\n        .fill(null)\n        .map(\n          () =>\n            new NextRequest('http://localhost:3000/api/admin/auth', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n              },\n              body: JSON.stringify({\n                email: 'test@example.com',\n                password: 'wrongpassword',\n              }),\n            })\n        );\n\n      const responses = await Promise.all(requests.map(req => authPOST(req)));\n\n      // All requests should be handled (even if they fail)\n      responses.forEach(response => {\n        expect([400, 401, 429]).toContain(response.status);\n      });\n    });\n\n    it('should validate token signature', async () => {\n      const tokenWithWrongSecret = jwt.sign(\n        {\n          adminId: 'admin_test@example.com',\n          email: 'test@example.com',\n          role: 'super_admin',\n        },\n        'wrong-secret'\n      );\n\n      expect(() => {\n        jwt.verify(tokenWithWrongSecret, process.env.JWT_SECRET!);\n      }).toThrow('invalid signature');\n    });\n  });\n\n  describe('Performance Tests', () => {\n    it('should handle concurrent login requests', async () => {\n      const mockAdmin = {\n        id: 'admin_123',\n        email: 'test@example.com',\n        name: 'Test Admin',\n        role: 'super_admin',\n        password_hash: 'hashed_password',\n        is_active: true,\n        created_at: new Date().toISOString(),\n      };\n\n      const mockSingle = Promise.resolve({\n        data: mockAdmin,\n        error: null,\n      });\n\n      const mockEq = jest.fn().mockReturnValue({\n        single: () => mockSingle,\n      });\n\n      const mockSelect = jest.fn().mockReturnValue({\n        eq: mockEq,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: mockSelect,\n        update: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({ error: null }),\n        }),\n      });\n\n      bcrypt.compare.mockResolvedValue(true);\n\n      const requests = Array(5)\n        .fill(null)\n        .map(\n          () =>\n            new NextRequest('http://localhost:3000/api/admin/auth', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json',\n              },\n              body: JSON.stringify({\n                email: 'test@example.com',\n                password: 'testpassword123',\n              }),\n            })\n        );\n\n      const startTime = Date.now();\n      const responses = await Promise.all(requests.map(req => authPOST(req)));\n      const endTime = Date.now();\n\n      // All requests should be handled\n      responses.forEach(response => {\n        expect([200, 400, 401]).toContain(response.status);\n      });\n\n      // Should complete within reasonable time (5 seconds)\n      expect(endTime - startTime).toBeLessThan(5000);\n    });\n  });\n});\n"],"names":["jest","mock","actual","requireActual","NextResponse","json","body","init","response","_body","JSON","stringify","mockSupabaseClient","from","fn","createClient","compare","hash","adminConfig","security","saltRounds","sessionTimeout","jwt","secret","getResponseData","undefined","parse","data","Object","keys","length","text","describe","bcrypt","require","consoleErrorSpy","beforeEach","clearAllMocks","mockClear","process","env","JWT_SECRET","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE_KEY","spyOn","console","mockImplementation","afterEach","mockRestore","it","mockAdmin","id","email","name","role","password_hash","is_active","created_at","Date","toISOString","mockSingle","Promise","resolve","error","mockEq","mockReturnValue","single","mockSelect","eq","select","update","mockResolvedValue","loginRequest","NextRequest","method","headers","password","loginResponse","authPOST","loginData","expect","status","toBe","success","admin","token","toBeDefined","expiresAt","decoded","verify","adminId","exp","expirationTime","now","twentyFourHours","toBeGreaterThan","toBeLessThan","message","toBeUndefined","expiredToken","sign","iat","Math","floor","toThrow","invalidToken","validToken","reject","Error","not","toContain","requests","Array","fill","map","responses","all","req","forEach","tokenWithWrongSecret","startTime","endTime"],"mappings":"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"}