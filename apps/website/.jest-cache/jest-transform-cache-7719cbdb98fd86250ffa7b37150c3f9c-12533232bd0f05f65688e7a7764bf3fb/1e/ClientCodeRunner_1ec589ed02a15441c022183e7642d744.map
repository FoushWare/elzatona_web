{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/libs/shared-components/src/lib/admin/ClientCodeRunner.tsx"],"sourcesContent":["'use client';\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env['NEXT_PUBLIC_SUPABASE_URL']!;\nconst supabaseServiceRoleKey = process.env['SUPABASE_SERVICE_ROLE_KEY']!;\nconst supabase = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nexport interface TestCase {\n  id: string;\n  input: unknown[]; // arguments array\n  expected: unknown; // expected return value\n  description?: string;\n}\n\nexport interface ClientCodeRunnerProps {\n  functionName: string; // e.g., 'twoSum'\n  userCode: string; // function implementation as string\n  testCases: TestCase[];\n}\n\ninterface TestResult {\n  id: string;\n  passed: boolean;\n  actual: unknown;\n  expected: unknown;\n  error?: string;\n  elapsedMs?: number;\n}\n\n// v1.0\nexport default function ClientCodeRunner({\n  functionName,\n  userCode,\n  testCases,\n}: ClientCodeRunnerProps) {\n  const iframeRef = useRef<HTMLIFrameElement | null>(null);\n  const [results, setResults] = useState<TestResult[]>([]);\n  const [running, setRunning] = useState(false);\n  const [customInput, setCustomInput] = useState<string>('');\n  const [customResult, setCustomResult] = useState<TestResult | null>(null);\n\n  useEffect(() => {\n    const handleMessage = (e: MessageEvent) => {\n      if (!e.data || e.data.type !== 'runner:results') return;\n      setRunning(false);\n      setResults(e.data.results as TestResult[]);\n    };\n    const handleCustom = (e: MessageEvent) => {\n      if (!e.data || e.data.type !== 'runner:custom:result') return;\n      setRunning(false);\n      setCustomResult(e.data.result as TestResult);\n    };\n    window.addEventListener('message', handleMessage);\n    window.addEventListener('message', handleCustom);\n    return () => window.removeEventListener('message', handleMessage);\n  }, []);\n\n  const run = () => {\n    setRunning(true);\n    setResults([]);\n\n    const iframe = iframeRef.current;\n    if (!iframe) return;\n\n    const safeCode = userCode\n      .replace(/import\\s+[^;]+;?/g, '')\n      .replace(/export\\s+default\\s+/g, '')\n      .replace(/export\\s+\\{[^}]*\\};?/g, '')\n      .replace(/export\\s+\\w+\\s+/g, '');\n\n    const payload = {\n      fnName: functionName,\n      code: safeCode,\n      tests: testCases,\n    };\n\n    iframe.contentWindow?.postMessage({ type: 'runner:start', payload }, '*');\n  };\n\n  const srcDoc =\n    '<!doctype html>' +\n    '<html><head><meta charset=\"utf-8\"/></head><body>' +\n    '<script>\\n' +\n    'function deepEqual(a,b){try{return JSON.stringify(a)===JSON.stringify(b)}catch(e){return false}}\\n' +\n    'function safeEval(code){return (0,eval)(code)}\\n' +\n    'function withTimeout(fn,args,ms){return new Promise((resolve,reject)=>{const t=setTimeout(()=>reject(new Error(\"Timeout\")),ms);try{const res=fn.apply(null,args);Promise.resolve(res).then(v=>{clearTimeout(t);resolve(v)}).catch(err=>{clearTimeout(t);reject(err)});}catch(err){clearTimeout(t);reject(err);}})}\\n' +\n    'window.addEventListener(\"message\",async(e)=>{\\n' +\n    '  if(!e.data||e.data.type!==\"runner:start\")return;\\n' +\n    '  const {fnName,code,tests}=e.data.payload;\\n' +\n    '  let fn; let results=[];\\n' +\n    '  try{\\n' +\n    '    // sandbox minimal globals\\n' +\n    '    const console={log:()=>{},error:()=>{},warn:()=>{},info:()=>{}};\\n' +\n    '    safeEval(code);\\n' +\n    '    fn=eval(fnName);\\n' +\n    '  }catch(err){\\n' +\n    '    results=tests.map(t=>({id:t.id,passed:false,actual:null,expected:t.expected,error:String(err)}));\\n' +\n    '    parent.postMessage({type:\"runner:results\",results},\"*\");\\n' +\n    '    return;\\n' +\n    '  }\\n' +\n    '  for(const t of tests){\\n' +\n    '    try{\\n' +\n    '      const args=Array.isArray(t.input)?t.input:[t.input];\\n' +\n    '      const start=performance.now();\\n' +\n    '      const actual=await withTimeout(fn,args,1500);\\n' +\n    '      const elapsed=performance.now()-start;\\n' +\n    '      const passed=deepEqual(actual,t.expected);\\n' +\n    '      results.push({id:t.id,passed,actual,expected:t.expected,elapsedMs:Math.round(elapsed)});\\n' +\n    '    }catch(err){\\n' +\n    '      results.push({id:t.id,passed:false,actual:null,expected:t.expected,error:String(err),elapsedMs:0});\\n' +\n    '    }\\n' +\n    '  }\\n' +\n    '  parent.postMessage({type:\"runner:results\",results},\"*\");\\n' +\n    '});\\n' +\n    '// custom single-run handler\\n' +\n    'window.addEventListener(\"message\",async(e)=>{\\n' +\n    '  if(!e.data||e.data.type!==\"runner:custom\")return;\\n' +\n    '  const {fnName,code,input}=e.data.payload;\\n' +\n    '  try{safeEval(code);}catch(err){parent.postMessage({type:\"runner:custom:result\",result:{id:\"custom\",passed:false,actual:null,expected:null,error:String(err),elapsedMs:0}},\"*\");return;}\\n' +\n    '  let fn;try{fn=eval(fnName);}catch(err){parent.postMessage({type:\"runner:custom:result\",result:{id:\"custom\",passed:false,actual:null,expected:null,error:String(err),elapsedMs:0}},\"*\");return;}\\n' +\n    '  try{const args=Array.isArray(input)?input:[input];const start=performance.now();const actual=await withTimeout(fn,args,1500);const elapsed=performance.now()-start;parent.postMessage({type:\"runner:custom:result\",result:{id:\"custom\",passed:true,actual,expected:null,elapsedMs:Math.round(elapsed)}},\"*\");}catch(err){parent.postMessage({type:\"runner:custom:result\",result:{id:\"custom\",passed:false,actual:null,expected:null,error:String(err),elapsedMs:0}},\"*\");}\\n' +\n    '});\\n' +\n    '<\\/script>' +\n    '</body></html>';\n\n  return (\n    <div className='space-y-3'>\n      <div className='flex items-center gap-2'>\n        <button\n          onClick={run}\n          disabled={running}\n          className='px-3 py-2 rounded bg-blue-600 text-white disabled:opacity-50'\n        >\n          {running ? 'Runningâ€¦' : 'Run Tests'}\n        </button>\n        <span className='text-sm text-gray-500'>Client sandbox (iframe)</span>\n      </div>\n      <iframe\n        ref={iframeRef}\n        srcDoc={srcDoc}\n        className='w-0 h-0 border-0'\n        title='runner'\n      />\n      <div className='flex items-start gap-2'>\n        <textarea\n          placeholder='Custom input as JSON array, e.g. [ [2,7,11,15], 9 ]'\n          value={customInput}\n          onChange={e => setCustomInput(e.target.value)}\n          className='flex-1 min-h-[56px] bg-gray-900 border border-gray-700 rounded p-2 text-sm font-mono'\n        />\n        <button\n          onClick={() => {\n            setRunning(true);\n            setCustomResult(null);\n            let parsed;\n            try {\n              parsed = customInput ? JSON.parse(customInput) : [];\n            } catch (err) {\n              setRunning(false);\n              setCustomResult({\n                id: 'custom',\n                passed: false,\n                actual: null,\n                expected: null,\n                error: 'Invalid JSON',\n                elapsedMs: 0,\n              });\n              return;\n            }\n            const iframe = iframeRef.current;\n            if (!iframe) {\n              setRunning(false);\n              return;\n            }\n            const safeCode = userCode\n              .replace(/import\\s+[^;]+;?/g, '')\n              .replace(/export\\s+default\\s+/g, '')\n              .replace(/export\\s+\\{[^}]*\\};?/g, '')\n              .replace(/export\\s+\\w+\\s+/g, '');\n            iframe.contentWindow?.postMessage(\n              {\n                type: 'runner:custom',\n                payload: {\n                  fnName: functionName,\n                  code: safeCode,\n                  input: parsed,\n                },\n              },\n              '*'\n            );\n          }}\n          className='px-3 py-2 rounded bg-emerald-600 text-white'\n        >\n          Run Custom\n        </button>\n      </div>\n      {customResult && (\n        <div className='text-sm rounded border border-gray-700 p-2'>\n          <div\n            className={\n              (customResult.passed ? 'text-green-500' : 'text-red-500') +\n              ' font-medium'\n            }\n          >\n            {customResult.passed ? 'EXECUTED' : 'ERROR'}{' '}\n            {customResult.elapsedMs ? `(${customResult.elapsedMs} ms)` : ''}\n          </div>\n          <div className='text-gray-300'>\n            Actual: {formatVal(customResult.actual)}\n          </div>\n          {customResult.error && (\n            <div className='text-red-400'>{customResult.error}</div>\n          )}\n        </div>\n      )}\n      <div className='rounded border border-gray-700'>\n        <table className='w-full text-sm'>\n          <thead>\n            <tr className='bg-gray-800 text-gray-200'>\n              <th className='text-left p-2'>Test</th>\n              <th className='text-left p-2'>Result</th>\n              <th className='text-left p-2'>Time</th>\n              <th className='text-left p-2'>Actual</th>\n              <th className='text-left p-2'>Expected</th>\n              <th className='text-left p-2'>Error</th>\n            </tr>\n          </thead>\n          <tbody>\n            {results.map(r => (\n              <tr key={r.id} className='border-t border-gray-700'>\n                <td className='p-2'>{r.id}</td>\n                <td\n                  className={\n                    'p-2 ' + (r.passed ? 'text-green-500' : 'text-red-500')\n                  }\n                >\n                  {r.passed ? 'PASS' : 'FAIL'}\n                </td>\n                <td className='p-2 text-gray-400'>{r.elapsedMs ?? ''}</td>\n                <td className='p-2 text-gray-300'>{formatVal(r.actual)}</td>\n                <td className='p-2 text-gray-300'>{formatVal(r.expected)}</td>\n                <td className='p-2 text-red-400'>{r.error || ''}</td>\n              </tr>\n            ))}\n            {results.length === 0 && (\n              <tr>\n                <td className='p-3 text-gray-400' colSpan={5}>\n                  No results yet\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n\nfunction formatVal(v: unknown): string {\n  try {\n    return typeof v === 'string' ? v : JSON.stringify(v);\n  } catch {\n    return String(v);\n  }\n}\n"],"names":["ClientCodeRunner","supabaseUrl","process","env","supabaseServiceRoleKey","supabase","createClient","functionName","userCode","testCases","iframeRef","useRef","results","setResults","useState","running","setRunning","customInput","setCustomInput","customResult","setCustomResult","useEffect","handleMessage","e","data","type","handleCustom","result","window","addEventListener","removeEventListener","run","iframe","current","safeCode","replace","payload","fnName","code","tests","contentWindow","postMessage","srcDoc","div","className","button","onClick","disabled","span","ref","title","textarea","placeholder","value","onChange","target","parsed","JSON","parse","err","id","passed","actual","expected","error","elapsedMs","input","formatVal","table","thead","tr","th","tbody","map","r","td","length","colSpan","v","stringify","String"],"mappings":"AAAA;;;;;+BA+BA,OAAO;AACP;;;eAAwBA;;;;+DA9B2B;4BACtB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE7B,MAAMC,cAAcC,QAAQC,GAAG,CAAC,2BAA2B;AAC3D,MAAMC,yBAAyBF,QAAQC,GAAG,CAAC,4BAA4B;AACvE,MAAME,WAAWC,IAAAA,wBAAY,EAACL,aAAaG;AAyB5B,SAASJ,iBAAiB,EACvCO,YAAY,EACZC,QAAQ,EACRC,SAAS,EACa;IACtB,MAAMC,YAAYC,IAAAA,aAAM,EAA2B;IACnD,MAAM,CAACC,SAASC,WAAW,GAAGC,IAAAA,eAAQ,EAAe,EAAE;IACvD,MAAM,CAACC,SAASC,WAAW,GAAGF,IAAAA,eAAQ,EAAC;IACvC,MAAM,CAACG,aAAaC,eAAe,GAAGJ,IAAAA,eAAQ,EAAS;IACvD,MAAM,CAACK,cAAcC,gBAAgB,GAAGN,IAAAA,eAAQ,EAAoB;IAEpEO,IAAAA,gBAAS,EAAC;QACR,MAAMC,gBAAgB,CAACC;YACrB,IAAI,CAACA,EAAEC,IAAI,IAAID,EAAEC,IAAI,CAACC,IAAI,KAAK,kBAAkB;YACjDT,WAAW;YACXH,WAAWU,EAAEC,IAAI,CAACZ,OAAO;QAC3B;QACA,MAAMc,eAAe,CAACH;YACpB,IAAI,CAACA,EAAEC,IAAI,IAAID,EAAEC,IAAI,CAACC,IAAI,KAAK,wBAAwB;YACvDT,WAAW;YACXI,gBAAgBG,EAAEC,IAAI,CAACG,MAAM;QAC/B;QACAC,OAAOC,gBAAgB,CAAC,WAAWP;QACnCM,OAAOC,gBAAgB,CAAC,WAAWH;QACnC,OAAO,IAAME,OAAOE,mBAAmB,CAAC,WAAWR;IACrD,GAAG,EAAE;IAEL,MAAMS,MAAM;QACVf,WAAW;QACXH,WAAW,EAAE;QAEb,MAAMmB,SAAStB,UAAUuB,OAAO;QAChC,IAAI,CAACD,QAAQ;QAEb,MAAME,WAAW1B,SACd2B,OAAO,CAAC,qBAAqB,IAC7BA,OAAO,CAAC,wBAAwB,IAChCA,OAAO,CAAC,yBAAyB,IACjCA,OAAO,CAAC,oBAAoB;QAE/B,MAAMC,UAAU;YACdC,QAAQ9B;YACR+B,MAAMJ;YACNK,OAAO9B;QACT;QAEAuB,OAAOQ,aAAa,EAAEC,YAAY;YAAEhB,MAAM;YAAgBW;QAAQ,GAAG;IACvE;IAEA,MAAMM,SACJ,oBACA,qDACA,eACA,uGACA,qDACA,yTACA,oDACA,yDACA,kDACA,gCACA,aACA,qCACA,2EACA,0BACA,2BACA,qBACA,4GACA,mEACA,kBACA,UACA,+BACA,eACA,iEACA,2CACA,0DACA,mDACA,uDACA,qGACA,uBACA,gHACA,YACA,UACA,iEACA,UACA,mCACA,oDACA,0DACA,kDACA,gMACA,wMACA,mdACA,UACA,eACA;IAEF,qBACE,sBAACC;QAAIC,WAAU;;0BACb,sBAACD;gBAAIC,WAAU;;kCACb,qBAACC;wBACCC,SAASf;wBACTgB,UAAUhC;wBACV6B,WAAU;kCAET7B,UAAU,aAAa;;kCAE1B,qBAACiC;wBAAKJ,WAAU;kCAAwB;;;;0BAE1C,qBAACZ;gBACCiB,KAAKvC;gBACLgC,QAAQA;gBACRE,WAAU;gBACVM,OAAM;;0BAER,sBAACP;gBAAIC,WAAU;;kCACb,qBAACO;wBACCC,aAAY;wBACZC,OAAOpC;wBACPqC,UAAU/B,CAAAA,IAAKL,eAAeK,EAAEgC,MAAM,CAACF,KAAK;wBAC5CT,WAAU;;kCAEZ,qBAACC;wBACCC,SAAS;4BACP9B,WAAW;4BACXI,gBAAgB;4BAChB,IAAIoC;4BACJ,IAAI;gCACFA,SAASvC,cAAcwC,KAAKC,KAAK,CAACzC,eAAe,EAAE;4BACrD,EAAE,OAAO0C,KAAK;gCACZ3C,WAAW;gCACXI,gBAAgB;oCACdwC,IAAI;oCACJC,QAAQ;oCACRC,QAAQ;oCACRC,UAAU;oCACVC,OAAO;oCACPC,WAAW;gCACb;gCACA;4BACF;4BACA,MAAMjC,SAAStB,UAAUuB,OAAO;4BAChC,IAAI,CAACD,QAAQ;gCACXhB,WAAW;gCACX;4BACF;4BACA,MAAMkB,WAAW1B,SACd2B,OAAO,CAAC,qBAAqB,IAC7BA,OAAO,CAAC,wBAAwB,IAChCA,OAAO,CAAC,yBAAyB,IACjCA,OAAO,CAAC,oBAAoB;4BAC/BH,OAAOQ,aAAa,EAAEC,YACpB;gCACEhB,MAAM;gCACNW,SAAS;oCACPC,QAAQ9B;oCACR+B,MAAMJ;oCACNgC,OAAOV;gCACT;4BACF,GACA;wBAEJ;wBACAZ,WAAU;kCACX;;;;YAIFzB,8BACC,sBAACwB;gBAAIC,WAAU;;kCACb,sBAACD;wBACCC,WACE,AAACzB,CAAAA,aAAa0C,MAAM,GAAG,mBAAmB,cAAa,IACvD;;4BAGD1C,aAAa0C,MAAM,GAAG,aAAa;4BAAS;4BAC5C1C,aAAa8C,SAAS,GAAG,CAAC,CAAC,EAAE9C,aAAa8C,SAAS,CAAC,IAAI,CAAC,GAAG;;;kCAE/D,sBAACtB;wBAAIC,WAAU;;4BAAgB;4BACpBuB,UAAUhD,aAAa2C,MAAM;;;oBAEvC3C,aAAa6C,KAAK,kBACjB,qBAACrB;wBAAIC,WAAU;kCAAgBzB,aAAa6C,KAAK;;;;0BAIvD,qBAACrB;gBAAIC,WAAU;0BACb,cAAA,sBAACwB;oBAAMxB,WAAU;;sCACf,qBAACyB;sCACC,cAAA,sBAACC;gCAAG1B,WAAU;;kDACZ,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;kDAC9B,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;kDAC9B,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;kDAC9B,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;kDAC9B,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;kDAC9B,qBAAC2B;wCAAG3B,WAAU;kDAAgB;;;;;sCAGlC,sBAAC4B;;gCACE5D,QAAQ6D,GAAG,CAACC,CAAAA,kBACX,sBAACJ;wCAAc1B,WAAU;;0DACvB,qBAAC+B;gDAAG/B,WAAU;0DAAO8B,EAAEd,EAAE;;0DACzB,qBAACe;gDACC/B,WACE,SAAU8B,CAAAA,EAAEb,MAAM,GAAG,mBAAmB,cAAa;0DAGtDa,EAAEb,MAAM,GAAG,SAAS;;0DAEvB,qBAACc;gDAAG/B,WAAU;0DAAqB8B,EAAET,SAAS,IAAI;;0DAClD,qBAACU;gDAAG/B,WAAU;0DAAqBuB,UAAUO,EAAEZ,MAAM;;0DACrD,qBAACa;gDAAG/B,WAAU;0DAAqBuB,UAAUO,EAAEX,QAAQ;;0DACvD,qBAACY;gDAAG/B,WAAU;0DAAoB8B,EAAEV,KAAK,IAAI;;;uCAZtCU,EAAEd,EAAE;gCAedhD,QAAQgE,MAAM,KAAK,mBAClB,qBAACN;8CACC,cAAA,qBAACK;wCAAG/B,WAAU;wCAAoBiC,SAAS;kDAAG;;;;;;;;;;AAU9D;AAEA,SAASV,UAAUW,CAAU;IAC3B,IAAI;QACF,OAAO,OAAOA,MAAM,WAAWA,IAAIrB,KAAKsB,SAAS,CAACD;IACpD,EAAE,OAAM;QACN,OAAOE,OAAOF;IAChB;AACF"}