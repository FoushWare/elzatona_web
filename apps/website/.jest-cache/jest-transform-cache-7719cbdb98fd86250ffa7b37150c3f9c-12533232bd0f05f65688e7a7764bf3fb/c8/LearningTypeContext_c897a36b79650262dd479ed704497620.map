{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/apps/website/src/context/LearningTypeContext.tsx"],"sourcesContent":["'use client';\n\n// v1.0\nimport React, {\n  createContext,\n  useCallback,\n  useContext,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport { supabaseClient } from '@/lib/supabase-client';\n\nexport type LearningType = 'guided' | 'free-style' | 'custom';\n\ntype LearningTypeContextValue = {\n  learningType: LearningType;\n  setLearningType: (type: LearningType) => void;\n  solvedQuestionIds: string[];\n  addSolvedQuestion: (questionId: string) => void;\n  clearSolvedQuestions: () => void;\n  userId: string | null;\n};\n\nconst LearningTypeContext = createContext<LearningTypeContextValue | undefined>(\n  undefined\n);\n\nconst BASE_KEY = 'learning-preferences';\n\nfunction buildStorageKey(userId: string | null, suffix: string) {\n  const scope = userId ? `${BASE_KEY}:${userId}` : BASE_KEY;\n  return `${scope}:${suffix}`;\n}\n\nexport function LearningTypeProvider({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const [userId, setUserId] = useState<string | null>(null);\n  const initializedRef = useRef(false);\n\n  // Initialize learning type from localStorage on mount (before auth check)\n  const getInitialLearningType = (): LearningType => {\n    // Always return default during SSR - actual value will be loaded in useEffect\n    if (typeof window === 'undefined') return 'guided';\n    try {\n      // First try universal key (works for logged out users)\n      const universalTypeKey = buildStorageKey(null, 'type');\n      const universalType = window?.localStorage?.getItem(universalTypeKey);\n      if (\n        universalType === 'guided' ||\n        universalType === 'free-style' ||\n        universalType === 'custom'\n      ) {\n        return universalType;\n      }\n    } catch (_e) {\n      // ignore\n    }\n    return 'guided';\n  };\n\n  const [learningType, setLearningTypeState] = useState<LearningType>(\n    getInitialLearningType()\n  );\n  const [solvedQuestionIds, setSolvedQuestionIds] = useState<string[]>([]);\n\n  // Load user and persist on auth changes\n  useEffect(() => {\n    let mounted = true;\n    const init = async () => {\n      try {\n        if (!supabaseClient) return;\n        const { data } = await supabaseClient.auth.getUser();\n        if (!mounted) return;\n        const newUserId = data.user?.id ?? null;\n        setUserId(newUserId);\n\n        // When userId changes (including logout), reload learning type from appropriate storage\n        const universalTypeKey = buildStorageKey(null, 'type');\n        const userTypeKey = buildStorageKey(newUserId, 'type');\n        const keyToLoad = newUserId ? userTypeKey : universalTypeKey;\n\n        try {\n          if (typeof window !== 'undefined' && window.localStorage) {\n            const rawType = window.localStorage.getItem(keyToLoad);\n            if (\n              rawType === 'guided' ||\n              rawType === 'free-style' ||\n              rawType === 'custom'\n            ) {\n              setLearningTypeState(rawType);\n            }\n          }\n        } catch (_e) {\n          // ignore\n        }\n      } catch (_) {\n        setUserId(null);\n        // Load from universal key when logged out\n        try {\n          if (typeof window !== 'undefined' && window.localStorage) {\n            const universalTypeKey = buildStorageKey(null, 'type');\n            const rawType = window.localStorage.getItem(universalTypeKey);\n            if (\n              rawType === 'guided' ||\n              rawType === 'free-style' ||\n              rawType === 'custom'\n            ) {\n              setLearningTypeState(rawType);\n            }\n          }\n        } catch (_e) {\n          // ignore\n        }\n      }\n    };\n    init();\n    if (!supabaseClient) {\n      return () => {\n        mounted = false;\n      };\n    }\n    const { data: sub } = supabaseClient.auth.onAuthStateChange(\n      (_event, session) => {\n        const newUserId = session?.user?.id ?? null;\n        setUserId(newUserId);\n\n        // Reload learning type when auth state changes\n        const universalTypeKey = buildStorageKey(null, 'type');\n        const userTypeKey = buildStorageKey(newUserId, 'type');\n        const keyToLoad = newUserId ? userTypeKey : universalTypeKey;\n\n        try {\n          if (typeof window !== 'undefined' && window.localStorage) {\n            const rawType = window.localStorage.getItem(keyToLoad);\n            if (\n              rawType === 'guided' ||\n              rawType === 'free-style' ||\n              rawType === 'custom'\n            ) {\n              setLearningTypeState(rawType);\n            }\n          }\n        } catch (_e) {\n          // ignore\n        }\n      }\n    );\n    return () => {\n      mounted = false;\n      sub.subscription?.unsubscribe();\n    };\n  }, []);\n\n  // Load from storage when userId known (or at first run)\n  useEffect(() => {\n    const typeKey = buildStorageKey(userId, 'type');\n    const universalTypeKey = buildStorageKey(null, 'type'); // Universal key that persists across logout\n    const solvedKey = buildStorageKey(userId, 'solved');\n    try {\n      // Priority: userId-specific key (if logged in) > universal key (if logged out)\n      let rawType: string | null = null;\n\n      if (typeof window !== 'undefined' && window.localStorage) {\n        if (userId) {\n          // When logged in, try user-specific key first, fallback to universal\n          rawType =\n            window.localStorage.getItem(typeKey) ||\n            window.localStorage.getItem(universalTypeKey);\n        } else {\n          // When logged out, use universal key\n          rawType = window.localStorage.getItem(universalTypeKey);\n        }\n      }\n\n      if (\n        rawType === 'guided' ||\n        rawType === 'free-style' ||\n        rawType === 'custom'\n      ) {\n        setLearningTypeState(rawType);\n      }\n      const rawSolved =\n        typeof window !== 'undefined' && window.localStorage\n          ? window.localStorage.getItem(solvedKey)\n          : null;\n      if (rawSolved) {\n        const parsed = JSON.parse(rawSolved);\n        if (Array.isArray(parsed))\n          setSolvedQuestionIds(parsed.filter(x => typeof x === 'string'));\n      }\n    } catch (_e) {\n      // ignore\n    } finally {\n      initializedRef.current = true;\n    }\n  }, [userId]);\n\n  // Persist changes - save to both userId-specific and universal key\n  useEffect(() => {\n    if (!initializedRef.current) return;\n    try {\n      const typeKey = buildStorageKey(userId, 'type');\n      const universalTypeKey = buildStorageKey(null, 'type'); // Universal key that persists across logout\n\n      if (typeof window !== 'undefined' && window.localStorage) {\n        // Save to userId-specific key if logged in\n        if (userId) {\n          window.localStorage.setItem(typeKey, learningType);\n        }\n\n        // Always save to universal key so it persists after logout\n        window.localStorage.setItem(universalTypeKey, learningType);\n      }\n    } catch (_e) {\n      // ignore\n    }\n  }, [learningType, userId]);\n\n  useEffect(() => {\n    if (!initializedRef.current) return;\n    try {\n      if (typeof window !== 'undefined' && window.localStorage) {\n        const solvedKey = buildStorageKey(userId, 'solved');\n        window.localStorage.setItem(\n          solvedKey,\n          JSON.stringify(solvedQuestionIds)\n        );\n      }\n    } catch (_e) {\n      // ignore\n    }\n  }, [solvedQuestionIds, userId]);\n\n  const setLearningType = useCallback((type: LearningType) => {\n    setLearningTypeState(type);\n    // Optionally sync preference to API here in future\n  }, []);\n\n  const addSolvedQuestion = useCallback((questionId: string) => {\n    setSolvedQuestionIds(prev =>\n      prev.includes(questionId) ? prev : [...prev, questionId]\n    );\n  }, []);\n\n  const clearSolvedQuestions = useCallback(() => {\n    setSolvedQuestionIds([]);\n  }, []);\n\n  const value = useMemo(\n    () => ({\n      learningType,\n      setLearningType,\n      solvedQuestionIds,\n      addSolvedQuestion,\n      clearSolvedQuestions,\n      userId,\n    }),\n    [\n      learningType,\n      setLearningType,\n      solvedQuestionIds,\n      addSolvedQuestion,\n      clearSolvedQuestions,\n      userId,\n    ]\n  );\n\n  return (\n    <LearningTypeContext.Provider value={value}>\n      {children}\n    </LearningTypeContext.Provider>\n  );\n}\n\nexport function useLearningType() {\n  const ctx = useContext(LearningTypeContext);\n  if (!ctx)\n    throw new Error('useLearningType must be used within LearningTypeProvider');\n  return ctx;\n}\n"],"names":["LearningTypeProvider","useLearningType","LearningTypeContext","createContext","undefined","BASE_KEY","buildStorageKey","userId","suffix","scope","children","setUserId","useState","initializedRef","useRef","getInitialLearningType","window","universalTypeKey","universalType","localStorage","getItem","_e","learningType","setLearningTypeState","solvedQuestionIds","setSolvedQuestionIds","useEffect","mounted","init","supabaseClient","data","auth","getUser","newUserId","user","id","userTypeKey","keyToLoad","rawType","_","sub","onAuthStateChange","_event","session","subscription","unsubscribe","typeKey","solvedKey","rawSolved","parsed","JSON","parse","Array","isArray","filter","x","current","setItem","stringify","setLearningType","useCallback","type","addSolvedQuestion","questionId","prev","includes","clearSolvedQuestions","value","useMemo","Provider","ctx","useContext","Error"],"mappings":"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"}