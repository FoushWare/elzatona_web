{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/apps/website/src/app/api/admin/auth/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport jwt from 'jsonwebtoken';\nimport { createClient } from '@supabase/supabase-js';\nimport bcrypt from 'bcryptjs';\n// Admin config - using environment variables directly\n// Note: JWT secret is read at runtime to support test environments\nconst adminConfig = {\n  security: {\n    saltRounds: 10,\n    sessionTimeout: 24 * 60 * 60 * 1000,\n  },\n  get jwtSecret() {\n    return process.env.JWT_SECRET || 'default-secret';\n  },\n};\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nexport async function POST(request: NextRequest) {\n  try {\n    let body;\n    try {\n      body = await request.json();\n    } catch (_jsonError) {\n      // Handle invalid JSON\n      return NextResponse.json(\n        { success: false, error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const { email, password } = body;\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { success: false, error: 'Email and password are required' },\n        { status: 400 }\n      );\n    }\n\n    // Check if JWT_SECRET is set (not using fallback)\n    const jwtSecret = adminConfig.jwtSecret;\n    if (\n      !process.env.JWT_SECRET ||\n      jwtSecret === 'dev-secret-key-change-in-production'\n    ) {\n      return NextResponse.json(\n        { success: false, error: 'Server configuration error' },\n        { status: 500 }\n      );\n    }\n\n    // Query admin from Supabase\n    const { data: adminData, error } = await supabase\n      .from('admin_users')\n      .select('*')\n      .eq('email', email)\n      .single();\n\n    if (error || !adminData) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid email or password' },\n        { status: 401 }\n      );\n    }\n\n    // Check if admin is active\n    if (!adminData.is_active) {\n      return NextResponse.json(\n        { success: false, error: 'Admin account is deactivated' },\n        { status: 401 }\n      );\n    }\n\n    // Verify password\n    const isValidPassword = await bcrypt.compare(\n      password,\n      adminData.password_hash\n    );\n    if (!isValidPassword) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid email or password' },\n        { status: 401 }\n      );\n    }\n\n    // Create JWT token\n    const expiresAt = new Date();\n    expiresAt.setTime(\n      expiresAt.getTime() + adminConfig.security.sessionTimeout\n    );\n\n    const token = jwt.sign(\n      {\n        adminId: adminData.id,\n        email: adminData.email,\n        role: adminData.role,\n      },\n      jwtSecret,\n      { expiresIn: '24h' }\n    );\n\n    const session = {\n      id: adminData.id,\n      email: adminData.email,\n      name: adminData.name,\n      role: adminData.role,\n      token: token,\n      expiresAt: expiresAt.toISOString(),\n    };\n\n    return NextResponse.json({ success: true, admin: session });\n  } catch (error) {\n    console.error('Admin authentication error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\n\n    if (!token) {\n      return NextResponse.json(\n        { success: false, error: 'No token provided' },\n        { status: 401 }\n      );\n    }\n\n    // Verify JWT token (read secret at runtime)\n    const jwtSecret = adminConfig.jwtSecret;\n    const decoded = jwt.verify(token, jwtSecret) as {\n      adminId: string;\n      email: string;\n      role: string;\n    };\n\n    return NextResponse.json({\n      success: true,\n      admin: {\n        id: decoded.adminId,\n        email: decoded.email,\n        role: decoded.role,\n      },\n    });\n  } catch (error) {\n    console.error('Token verification error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Invalid token' },\n      { status: 401 }\n    );\n  }\n}\n"],"names":["GET","POST","adminConfig","security","saltRounds","sessionTimeout","jwtSecret","process","env","JWT_SECRET","supabaseUrl","NEXT_PUBLIC_SUPABASE_URL","supabaseServiceRoleKey","SUPABASE_SERVICE_ROLE_KEY","supabase","createClient","request","body","json","_jsonError","NextResponse","success","error","status","email","password","data","adminData","from","select","eq","single","is_active","isValidPassword","bcrypt","compare","password_hash","expiresAt","Date","setTime","getTime","token","jwt","sign","adminId","id","role","expiresIn","session","name","toISOString","admin","console","headers","get","replace","decoded","verify"],"mappings":"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"}