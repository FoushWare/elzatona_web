{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/libs/shared-contexts/src/lib/AdminAuthContext.tsx"],"sourcesContent":["'use client';\n\nimport React, {\n  useState,\n  useEffect,\n  useCallback,\n  ReactNode,\n  createContext,\n  useContext,\n} from 'react';\nimport { useRouter, usePathname } from 'next/navigation';\nimport { createClient } from '@supabase/supabase-js';\n\n// Create Supabase client\nconst supabaseUrl =\n  process.env['NEXT_PUBLIC_SUPABASE_URL'] ||\n  'https://hpnewqkvpnthpohvxcmq.supabase.co';\nconst supabaseAnonKey =\n  process.env['NEXT_PUBLIC_SUPABASE_ANON_KEY'] ||\n  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwbmV3cWt2cG50aHBvaHZ4Y21xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NjA0MTgsImV4cCI6MjA3NjIzNjQxOH0.UMmriJb5HRr9W_56GilNNDWksvlFEb1V9c_PuBK-H3s';\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\n\ninterface AdminSession {\n  id: string;\n  email: string;\n  role: string;\n  name?: string;\n  expiresAt: string;\n  created_at?: string;\n  updated_at?: string;\n}\n\ninterface AdminAuthContextType {\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  user: AdminSession | null;\n  login: (\n    email: string,\n    password: string\n  ) => Promise<{ success: boolean; error?: string }>;\n  logout: () => void;\n  error: string | null;\n}\n\nconst AdminAuthContext = createContext<AdminAuthContextType | undefined>(\n  undefined\n);\n\ninterface AdminAuthProviderProps {\n  children: ReactNode;\n}\n\nexport function AdminAuthProvider({ children }: AdminAuthProviderProps) {\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n  const [isLoading, setIsLoading] = useState(false); // Start with false for development\n  const [user, setUser] = useState<AdminSession | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isHydrated, setIsHydrated] = useState(true); // Start as hydrated for development\n\n  const router = useRouter();\n  const pathname = usePathname();\n\n  // Load session from localStorage on mount (for mock authentication)\n  useEffect(() => {\n    const checkSession = async () => {\n      try {\n        if (typeof window === 'undefined') {\n          setIsLoading(false);\n          return;\n        }\n\n        // Mark as hydrated first\n        setIsHydrated(true);\n\n        // Check for mock session in localStorage first\n        const storedSession = localStorage.getItem('admin_session');\n        if (storedSession) {\n          try {\n            const mockSession = JSON.parse(storedSession);\n            // Check if session is still valid (not expired)\n            if (new Date(mockSession.expiresAt) > new Date()) {\n              console.log('âœ… Restoring mock admin session');\n              setUser(mockSession);\n              setIsAuthenticated(true);\n              setIsLoading(false);\n              return;\n            } else {\n              // Session expired, remove it\n              localStorage.removeItem('admin_session');\n            }\n          } catch (error) {\n            console.error('Error parsing stored session:', error);\n            localStorage.removeItem('admin_session');\n          }\n        }\n\n        // If no mock session, check Supabase session\n        const {\n          data: { session },\n          error,\n        } = await supabase.auth.getSession();\n\n        console.log('ðŸ” AdminAuthProvider checking Supabase session:', {\n          hasSession: !!session,\n          pathname,\n          error: error?.message,\n        });\n\n        if (error) {\n          console.error('Error getting session:', error);\n          setIsAuthenticated(false);\n          setUser(null);\n          return;\n        }\n\n        if (session?.user) {\n          // Check if user is an admin by querying the admins table\n          const { data: adminData, error: adminError } = await supabase\n            .from('admins')\n            .select('*')\n            .eq('email', session.user.email)\n            .single();\n\n          if (adminError || !adminData) {\n            console.log('âŒ User is not an admin:', adminError?.message);\n            setIsAuthenticated(false);\n            setUser(null);\n            // Sign out the user if they're not an admin\n            await supabase.auth.signOut();\n            return;\n          }\n\n          console.log('âœ… Valid admin session found');\n          const adminSession: AdminSession = {\n            id: session.user.id,\n            email: session.user.email || '',\n            role: adminData.role || 'admin',\n            name: adminData.name || adminData.email,\n            expiresAt: new Date(session.expires_at! * 1000).toISOString(),\n            created_at: adminData.created_at,\n            updated_at: adminData.updated_at,\n          };\n\n          setUser(adminSession);\n          setIsAuthenticated(true);\n        } else {\n          console.log('âŒ No Supabase session found');\n          setIsAuthenticated(false);\n          setUser(null);\n        }\n      } catch (error) {\n        console.error('Error checking session:', error);\n        setIsAuthenticated(false);\n        setUser(null);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    checkSession();\n  }, []);\n\n  // Handle redirects for protected admin routes (excluding /admin root and /admin/login)\n  useEffect(() => {\n    if (isLoading) return;\n\n    const isLoginPage = pathname === '/admin/login';\n    const isAdminRootPage = pathname === '/admin';\n\n    // TEMPORARY: Skip authentication for development/testing\n    const isDevelopment = process.env['NODE_ENV'] === 'development';\n    const skipAuthForTesting =\n      isDevelopment &&\n      (pathname === '/' ||\n        pathname?.includes('/admin/content/questions') ||\n        pathname?.includes('/admin/enhanced-structure') ||\n        pathname?.includes('/admin/content-management') ||\n        pathname?.includes('/admin/dashboard'));\n\n    const isProtectedRoute =\n      pathname?.startsWith('/admin') && !isLoginPage && !skipAuthForTesting;\n\n    console.log('ðŸ”„ AdminAuthProvider redirect logic:', {\n      isLoading,\n      isAuthenticated,\n      isLoginPage,\n      isAdminRootPage,\n      skipAuthForTesting,\n      isProtectedRoute,\n      pathname,\n    });\n\n    // Handle /admin root path redirects\n    if (isAdminRootPage) {\n      if (isAuthenticated) {\n        console.log('âœ… User authenticated, redirecting to dashboard');\n        router.replace('/admin/dashboard');\n      } else {\n        console.log('ðŸš¨ User not authenticated, redirecting to login');\n        router.replace('/admin/login');\n      }\n      return;\n    }\n\n    // Redirect authenticated users away from login page\n    if (isAuthenticated && isLoginPage) {\n      console.log('âœ… User already authenticated, redirecting to dashboard');\n      router.replace('/admin/dashboard');\n      return;\n    }\n\n    // Only redirect from protected routes, not from login or testing routes\n    if (!isAuthenticated && isProtectedRoute) {\n      console.log(\n        'ðŸš¨ Redirecting to login - not authenticated on protected route'\n      );\n      router.replace('/admin/login');\n    }\n  }, [isAuthenticated, isLoading, router, pathname]);\n\n  // Login function\n  const login = useCallback(\n    async (email: string, password: string) => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        console.log('ðŸ” Attempting Supabase login for:', email);\n\n        // TEMPORARY: Mock authentication for testing dropdown functionality\n        if (\n          email === 'afouadsoftwareengineer@gmail.com' &&\n          password === 'ZatonaFoushware$8888'\n        ) {\n          console.log('âœ… Mock admin login successful (temporary)');\n\n          const mockSession: AdminSession = {\n            id: 'mock-admin-id',\n            email: email,\n            role: 'super_admin',\n            name: 'Admin User',\n            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 hours from now\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString(),\n          };\n\n          setUser(mockSession);\n          setIsAuthenticated(true);\n          setIsLoading(false);\n\n          // Store session in localStorage for persistence\n          localStorage.setItem('admin_session', JSON.stringify(mockSession));\n\n          return { success: true };\n        }\n\n        // If not mock authentication, show error\n        setError('Invalid credentials. Please try again.');\n        return { success: false, error: 'Invalid credentials' };\n      } catch (error) {\n        const errorMessage = 'An unexpected error occurred during login';\n        console.error('Login error:', error);\n        setError(errorMessage);\n        return { success: false, error: errorMessage };\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [router]\n  );\n\n  // Logout function\n  const logout = useCallback(async () => {\n    try {\n      console.log('ðŸšª Logging out admin user');\n\n      // Clear mock session from localStorage\n      localStorage.removeItem('admin_session');\n\n      // Clear local state\n      setUser(null);\n      setIsAuthenticated(false);\n      setError(null);\n\n      console.log('âœ… Admin logout successful');\n    } catch (error) {\n      console.error('Logout error:', error);\n      // Still clear local state even if logout fails\n      setUser(null);\n      setIsAuthenticated(false);\n      setError(null);\n    }\n  }, []);\n\n  const value = {\n    isAuthenticated,\n    isLoading: isLoading || !isHydrated,\n    user,\n    login,\n    logout,\n    error,\n  };\n\n  // Show loading state during hydration to prevent mismatches\n  if (!isHydrated) {\n    return (\n      <AdminAuthContext.Provider value={value}>\n        <div className='min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center'>\n          <div className='animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600'></div>\n        </div>\n      </AdminAuthContext.Provider>\n    );\n  }\n\n  return (\n    <AdminAuthContext.Provider value={value}>\n      {children}\n    </AdminAuthContext.Provider>\n  );\n}\n\nexport function useAdminAuth() {\n  const context = useContext(AdminAuthContext);\n  if (context === undefined) {\n    throw new Error('useAdminAuth must be used within an AdminAuthProvider');\n  }\n  return context;\n}\n"],"names":["AdminAuthProvider","useAdminAuth","supabaseUrl","process","env","supabaseAnonKey","supabase","createClient","AdminAuthContext","createContext","undefined","children","isAuthenticated","setIsAuthenticated","useState","isLoading","setIsLoading","user","setUser","error","setError","isHydrated","setIsHydrated","router","useRouter","pathname","usePathname","useEffect","checkSession","window","storedSession","localStorage","getItem","mockSession","JSON","parse","Date","expiresAt","console","log","removeItem","data","session","auth","getSession","hasSession","message","adminData","adminError","from","select","eq","email","single","signOut","adminSession","id","role","name","expires_at","toISOString","created_at","updated_at","isLoginPage","isAdminRootPage","isDevelopment","skipAuthForTesting","includes","isProtectedRoute","startsWith","replace","login","useCallback","password","now","setItem","stringify","success","errorMessage","logout","value","Provider","div","className","context","useContext","Error"],"mappings":"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"}