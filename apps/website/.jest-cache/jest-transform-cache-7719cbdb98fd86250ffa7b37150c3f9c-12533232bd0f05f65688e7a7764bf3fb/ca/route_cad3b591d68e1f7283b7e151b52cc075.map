{"version":3,"sources":["/Users/a.fouad/SideProjects/Elzatona-all/Elzatona-web/apps/website/src/app/api/admin/auth/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport jwt from 'jsonwebtoken';\nimport { createClient } from '@supabase/supabase-js';\nimport bcrypt from 'bcryptjs';\nimport { adminConfig } from '@/admin.config';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;\nconst supabase = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nexport async function POST(request: NextRequest) {\n  try {\n    let body;\n    try {\n      body = await request.json();\n    } catch (jsonError) {\n      // Handle invalid JSON\n      return NextResponse.json(\n        { success: false, error: 'Invalid JSON in request body' },\n        { status: 400 }\n      );\n    }\n\n    const { email, password } = body;\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { success: false, error: 'Email and password are required' },\n        { status: 400 }\n      );\n    }\n\n    // Check if JWT_SECRET is set (not using fallback)\n    if (\n      !process.env.JWT_SECRET ||\n      adminConfig.jwt.secret === 'dev-secret-key-change-in-production'\n    ) {\n      return NextResponse.json(\n        { success: false, error: 'Server configuration error' },\n        { status: 500 }\n      );\n    }\n\n    // Query admin from Supabase\n    const { data: adminData, error } = await supabase\n      .from('admin_users')\n      .select('*')\n      .eq('email', email)\n      .single();\n\n    if (error || !adminData) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid email or password' },\n        { status: 401 }\n      );\n    }\n\n    // Check if admin is active\n    if (!adminData.is_active) {\n      return NextResponse.json(\n        { success: false, error: 'Admin account is deactivated' },\n        { status: 401 }\n      );\n    }\n\n    // Verify password\n    const isValidPassword = await bcrypt.compare(\n      password,\n      adminData.password_hash\n    );\n    if (!isValidPassword) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid email or password' },\n        { status: 401 }\n      );\n    }\n\n    // Create JWT token\n    const expiresAt = new Date();\n    expiresAt.setTime(\n      expiresAt.getTime() + adminConfig.security.sessionTimeout\n    );\n\n    const token = jwt.sign(\n      {\n        adminId: adminData.id,\n        email: adminData.email,\n        role: adminData.role,\n      },\n      adminConfig.jwt.secret,\n      { expiresIn: '24h' }\n    );\n\n    const session = {\n      id: adminData.id,\n      email: adminData.email,\n      name: adminData.name,\n      role: adminData.role,\n      token: token,\n      expiresAt: expiresAt.toISOString(),\n    };\n\n    return NextResponse.json({ success: true, admin: session });\n  } catch (error) {\n    console.error('Admin authentication error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const token = request.headers.get('authorization')?.replace('Bearer ', '');\n\n    if (!token) {\n      return NextResponse.json(\n        { success: false, error: 'No token provided' },\n        { status: 401 }\n      );\n    }\n\n    // Verify JWT token\n    const decoded = jwt.verify(token, adminConfig.jwt.secret) as {\n      adminId: string;\n      email: string;\n      role: string;\n    };\n\n    return NextResponse.json({\n      success: true,\n      admin: {\n        id: decoded.adminId,\n        email: decoded.email,\n        role: decoded.role,\n      },\n    });\n  } catch (error) {\n    console.error('Token verification error:', error);\n    return NextResponse.json(\n      { success: false, error: 'Invalid token' },\n      { status: 401 }\n    );\n  }\n}\n"],"names":["GET","POST","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseServiceRoleKey","SUPABASE_SERVICE_ROLE_KEY","supabase","createClient","request","body","json","jsonError","NextResponse","success","error","status","email","password","JWT_SECRET","adminConfig","jwt","secret","data","adminData","from","select","eq","single","is_active","isValidPassword","bcrypt","compare","password_hash","expiresAt","Date","setTime","getTime","security","sessionTimeout","token","sign","adminId","id","role","expiresIn","session","name","toISOString","admin","console","headers","get","replace","decoded","verify"],"mappings":"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"}