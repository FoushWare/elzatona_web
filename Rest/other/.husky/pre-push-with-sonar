#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "üöÄ PRE-PUSH HOOK (with Optional Quick SonarQube)..."
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Get the current branch name
current_branch=$(git branch --show-current)
echo "üìç Current branch: $current_branch"
echo ""

# Only run comprehensive checks on development branches
if [[ "$current_branch" == "release/v1.0.0-main-website" ]] || [[ "$current_branch" == "develop" ]] || [[ "$current_branch" == "main" ]]; then
  echo "üîÑ Running pre-push checks on development branch..."
  echo ""
  
  # Step 1: Auto-fix linting issues
  echo "üîç STEP 1: Running ESLint with auto-fix..."
  echo "   üìù Executing: npm run lint:fix"
  echo ""
  
  npm run lint:fix
  LINT_FIX_EXIT_CODE=$?
  
  echo ""
  if [ $LINT_FIX_EXIT_CODE -ne 0 ]; then
    echo "   ‚ö†Ô∏è  ESLint auto-fix completed with warnings"
  else
    echo "   ‚úÖ ESLint auto-fix completed successfully!"
  fi
  echo ""
  
  # Step 2: Run linting check
  echo "üîç STEP 2: Running ESLint check..."
  npm run lint || true
  echo ""
  
  # Step 3: TypeScript type checking
  echo "üìò STEP 3: Running TypeScript type checking..."
  npm run type-check
  TS_EXIT_CODE=$?
  
  if [ $TS_EXIT_CODE -ne 0 ]; then
    echo "   ‚ùå TypeScript errors detected!"
    exit 1
  fi
  echo "   ‚úÖ TypeScript check passed!"
  echo ""
  
  # Step 4: Build validation
  echo "üèóÔ∏è  STEP 4: Running build validation..."
  npm run build
  BUILD_EXIT_CODE=$?
  
  if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "   ‚ùå Build failed!"
    exit 1
  fi
  echo "   ‚úÖ Build passed!"
  echo ""
  
  # Step 5: OPTIONAL Quick SonarQube check
  # Only run if SONAR_ENABLE_PRE_PUSH is set to "true"
  if [ "$SONAR_ENABLE_PRE_PUSH" = "true" ]; then
    echo "üîç STEP 5: Running Quick SonarQube check (OPTIONAL)..."
    echo "   ‚è≥ This may take 2-3 minutes..."
    echo "   üí° To disable: unset SONAR_ENABLE_PRE_PUSH"
    echo ""
    
    npm run sonar:quick
    SONAR_EXIT_CODE=$?
    
    if [ $SONAR_EXIT_CODE -ne 0 ]; then
      echo "   ‚ö†Ô∏è  SonarQube found issues (non-blocking)"
      echo "   üí° Review results at: https://sonarcloud.io/dashboard?id=FoushWare_GreatFrontendHub"
    else
      echo "   ‚úÖ Quick SonarQube check passed!"
    fi
    echo ""
  else
    echo "üîç STEP 5: Skipping SonarQube (not enabled)"
    echo "   üí° To enable: export SONAR_ENABLE_PRE_PUSH=true"
    echo "   üí° Full analysis runs in GitHub Actions automatically"
    echo ""
  fi
  
  # Step 6: Add auto-fixed files
  echo "üì¶ STEP 6: Adding auto-fixed files to staging..."
  git add .
  echo ""
  
  # Step 7: Cleanup
  echo "üßπ STEP 7: Cleaning build files..."
  rm -rf .next build storybook-static test-results coverage 2>/dev/null || true
  echo ""
  
  echo "‚úÖ PRE-PUSH CHECKS COMPLETED!"
  echo ""
else
  echo "‚ÑπÔ∏è  Skipping checks on non-development branch"
  echo ""
fi

