#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ” PRE-COMMIT HOOK (FAST WITH TESTS) STARTING..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Run Prettier formatting
echo "ðŸŽ¨ STEP 1: Running Prettier formatting..."
npm run format > /dev/null 2>&1
PRETTIER_EXIT_CODE=$?

if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
  echo "   âŒ Prettier formatting failed"
  exit 1
fi
echo "   âœ… Prettier formatting completed"

# Step 2: Run ESLint (quick check)
echo "ðŸ” STEP 2: Running ESLint (quick check)..."
npm run lint > /dev/null 2>&1
LINT_EXIT_CODE=$?

if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "   âš ï¸  ESLint found issues (allowing to pass)"
fi
echo "   âœ… ESLint check completed"

# Step 3: Run Unit Tests (only affected files)
echo "ðŸ§ª STEP 3: Running Unit Tests (affected files only)..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "   â„¹ï¸  No test files staged, running all unit tests..."
  npm run test:unit -- --passWithNoTests --maxWorkers=50% --bail > /dev/null 2>&1
else
  echo "   ðŸ“ Running tests for staged test files..."
  echo "$STAGED_FILES" | xargs npm run test:unit -- --passWithNoTests --maxWorkers=50% --bail > /dev/null 2>&1
fi

UNIT_TEST_EXIT_CODE=$?

if [ $UNIT_TEST_EXIT_CODE -ne 0 ]; then
  echo "   âŒ Unit tests failed"
  echo "   ðŸ’¡ Run 'npm run test:unit' to see details"
  exit 1
fi
echo "   âœ… Unit tests passed"

# Step 4: Add formatted files
echo "ðŸ“¦ STEP 4: Adding formatted files to staging..."
git add . > /dev/null 2>&1

echo ""
echo "âœ… PRE-COMMIT CHECKS COMPLETED!"
echo "ðŸš€ READY TO COMMIT!"
echo ""

